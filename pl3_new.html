<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>PL32 水流模型分析器</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
<style>
body { background:#f7f7f7; }
.score-hot { color:#d9534f; font-weight:bold; }
.score-cold { color:#0275d8; }
table { font-size:14px; }
</style>
</head>

<body class="container my-4">

<h2 class="mb-3">PL32 水流模型分析器</h2>

<div class="row mb-3">
  <div class="col-md-3">
    <select id="windowSize" class="form-select">
      <option value="50">最近 50 期</option>
      <option value="100">最近 100 期</option>
    </select>
  </div>
  <div class="col-md-3">
    <button id="analyzeBtn" class="btn btn-primary">开始分析</button>
  </div>
</div>

<hr>

<h4>号码评分（水流模型）</h4>
<table class="table table-bordered table-sm" id="scoreTable">
<thead class="table-light">
<tr>
<th>号码</th>
<th>热度</th>
<th>冷却期</th>
<th>耦合度</th>
<th>水流评分</th>
</tr>
</thead>
<tbody></tbody>
</table>

<h4 class="mt-4">推荐号码（已过滤最近150期）</h4>
<ul id="recommendList" class="list-group"></ul>

<script>
const DATA_URL = "https://data.17500.cn/pl32_desc.txt";

function parseData(text) {
  return text.trim().split("\n").map(line => {
    let p = line.trim().split(/\s+/);
    return {
      issue: p[0],
      d: [p[2], p[3], p[4]].map(Number)
    };
  });
}

function analyze(data, windowSize) {
  let windowData = data.slice(0, windowSize);
  let allData150 = data.slice(0,150);

  let heat = Array(10).fill(0);
  let lastSeen = Array(10).fill(null);
  let coupling = Array.from({length:10}, ()=>Array(10).fill(0));

  windowData.forEach((row, idx)=>{
    let nums = row.d;
    nums.forEach(n=>{
      heat[n]++;
      if(lastSeen[n] === null) lastSeen[n] = idx;
    });
    for(let i=0;i<nums.length;i++){
      for(let j=i+1;j<nums.length;j++){
        coupling[nums[i]][nums[j]]++;
        coupling[nums[j]][nums[i]]++;
      }
    }
  });

  let waterScore = [];
  for(let i=0;i<10;i++){
    let cooling = lastSeen[i] === null ? windowSize+5 : lastSeen[i];
    let coupleScore = coupling[i].reduce((a,b)=>a+b,0);

    // 水流模型核心公式（可调）
    let score =
      heat[i] * 1.4
      - cooling * 0.6
      + Math.sqrt(coupleScore) * 0.8;

    waterScore.push({
      num:i,
      heat:heat[i],
      cooling:cooling,
      couple:coupleScore,
      score:score
    });
  }

  // 最近150期出现的号码
  let recent150 = new Set();
  allData150.forEach(r=>r.d.forEach(n=>recent150.add(n)));

  return {waterScore, recent150};
}

$("#analyzeBtn").on("click", function(){
  let windowSize = parseInt($("#windowSize").val());

  $.get(DATA_URL, function(text){
    let data = parseData(text);
    let result = analyze(data, windowSize);

    let tbody = $("#scoreTable tbody").empty();
    result.waterScore
      .sort((a,b)=>b.score-a.score)
      .forEach(r=>{
        let cls = r.score > 0 ? "score-hot" : "score-cold";
        tbody.append(`
          <tr>
            <td>${r.num}</td>
            <td>${r.heat}</td>
            <td>${r.cooling}</td>
            <td>${r.couple}</td>
            <td class="${cls}">${r.score.toFixed(2)}</td>
          </tr>
        `);
      });

    let ul = $("#recommendList").empty();
    result.waterScore
      .filter(r=>!result.recent150.has(r.num))
      .sort((a,b)=>b.score-a.score)
      .slice(0,3)
      .forEach(r=>{
        ul.append(`<li class="list-group-item">推荐号码：<strong>${r.num}</strong>（评分 ${r.score.toFixed(2)}）</li>`);
      });
  });
});
</script>

</body>
</html>
