<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åä¹Œåˆä¹‹ä¼— Â· æ’åˆ—ä¸‰ç»„é€‰6ç­–ç•¥ç”Ÿæˆå™¨</title>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <style>
        /* ========== åŸºç¡€é‡ç½®ä¸å…¨å±€å˜é‡ ========== */
        :root {
            --bg-primary: #0a0e17;
            --bg-secondary: #131a2b;
            --bg-tertiary: #1a2440;
            --accent-blue: #3b82f6;
            --accent-purple: #8b5cf6;
            --accent-cyan: #06b6d4;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border-color: #2d3a5c;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --gradient-primary: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            --gradient-card: linear-gradient(145deg, #1e2a4a, #151d35);
            --shadow-glow: 0 0 30px rgba(59, 130, 246, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* ========== å¸ƒå±€å®¹å™¨ ========== */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: 24px;
            margin-top: 24px;
        }

        @media (max-width: 1024px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
        }

        /* ========== å¤´éƒ¨åŒºåŸŸ ========== */
        header {
            text-align: center;
            padding: 40px 20px;
            background: var(--gradient-card);
            border-radius: 16px;
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-primary);
        }

        header h1 {
            font-size: 2.2rem;
            font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 12px;
        }

        header .subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
            letter-spacing: 2px;
        }

        header .badge {
            display: inline-block;
            margin-top: 16px;
            padding: 6px 16px;
            background: rgba(139, 92, 246, 0.2);
            border: 1px solid var(--accent-purple);
            border-radius: 20px;
            font-size: 0.85rem;
            color: var(--accent-purple);
        }

        /* ========== ä¸»å†…å®¹åŒº ========== */
        .main-content {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        /* ========== å¡ç‰‡é€šç”¨æ ·å¼ ========== */
        .card {
            background: var(--gradient-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 24px;
            transition: all 0.3s ease;
        }

        .card:hover {
            border-color: var(--accent-blue);
            box-shadow: var(--shadow-glow);
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-title .icon {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gradient-primary);
            border-radius: 8px;
            font-size: 1rem;
        }

        /* ========== ç­–ç•¥é€‰æ‹©å¡ç‰‡ ========== */
        .strategy-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        @media (max-width: 768px) {
            .strategy-grid {
                grid-template-columns: 1fr;
            }
        }

        .strategy-card {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .strategy-card:hover {
            border-color: var(--accent-blue);
            transform: translateY(-2px);
        }

        .strategy-card.active {
            border-color: var(--accent-purple);
            background: rgba(139, 92, 246, 0.1);
        }

        .strategy-card.active::before {
            content: 'âœ“';
            position: absolute;
            top: 12px;
            right: 12px;
            width: 24px;
            height: 24px;
            background: var(--accent-purple);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: white;
        }

        .strategy-card h3 {
            font-size: 1rem;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .strategy-card p {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .strategy-card .tag {
            display: inline-block;
            margin-top: 12px;
            padding: 4px 10px;
            background: rgba(59, 130, 246, 0.2);
            border-radius: 4px;
            font-size: 0.75rem;
            color: var(--accent-cyan);
        }

        /* ========== é«˜çº§é€‰é¡¹ ========== */
        .options-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 16px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }

        .checkbox-item input[type="checkbox"] {
            display: none;
        }

        .checkbox-item .checkmark {
            width: 22px;
            height: 22px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            background: var(--bg-secondary);
        }

        .checkbox-item input:checked + .checkmark {
            background: var(--accent-purple);
            border-color: var(--accent-purple);
        }

        .checkbox-item input:checked + .checkmark::after {
            content: 'âœ“';
            color: white;
            font-size: 14px;
        }

        .checkbox-item span {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* ========== ç”ŸæˆæŒ‰é’® ========== */
        .generate-btn {
            width: 100%;
            padding: 18px 32px;
            font-size: 1.2rem;
            font-weight: 600;
            color: white;
            background: var(--gradient-primary);
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 40px rgba(59, 130, 246, 0.4);
        }

        .generate-btn:active {
            transform: translateY(0);
        }

        .generate-btn.loading {
            pointer-events: none;
            opacity: 0.7;
        }

        .generate-btn .spinner {
            display: none;
            width: 24px;
            height: 24px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        .generate-btn.loading .spinner {
            display: inline-block;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ========== ç»“æœå±•ç¤ºåŒº ========== */
        .results-section {
            display: none;
        }

        .results-section.show {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 24px;
        }

        @media (max-width: 768px) {
            .results-grid {
                grid-template-columns: 1fr;
            }
        }

        .result-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 24px;
            text-align: center;
            position: relative;
            overflow: hidden;
            animation: flipIn 0.6s ease;
        }

        .result-card:nth-child(2) { animation-delay: 0.1s; }
        .result-card:nth-child(3) { animation-delay: 0.2s; }

        @keyframes flipIn {
            0% { transform: perspective(400px) rotateY(90deg); opacity: 0; }
            100% { transform: perspective(400px) rotateY(0); opacity: 1; }
        }

        .result-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }

        .result-card .label {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 12px;
        }

        .result-card .number {
            font-size: 3rem;
            font-weight: 700;
            letter-spacing: 8px;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 16px;
            font-family: 'Monaco', 'Consolas', monospace;
        }

        .result-card .analysis {
            font-size: 0.85rem;
            color: var(--text-secondary);
            text-align: left;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: 8px;
            line-height: 1.6;
        }

        .result-card .analysis .highlight {
            color: var(--accent-cyan);
            font-weight: 500;
        }

        /* ========== å¤§å¸ˆæ´å¯Ÿ ========== */
        .insight-box {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(59, 130, 246, 0.1));
            border: 1px solid var(--accent-purple);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            margin-top: 20px;
        }

        .insight-box .quote {
            font-style: italic;
            color: var(--text-primary);
            font-size: 1rem;
            line-height: 1.6;
        }

        .insight-box .author {
            margin-top: 12px;
            color: var(--accent-purple);
            font-size: 0.85rem;
        }

        /* ========== ä¾§è¾¹æ  ========== */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .sidebar .card {
            padding: 20px;
        }

        /* ========== è¿‘æœŸå¼€å¥– ========== */
        .history-list {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 12px;
        }

        .history-list::-webkit-scrollbar {
            width: 6px;
        }

        .history-list::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: 3px;
        }

        .history-list::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-bottom: 8px;
            transition: all 0.2s ease;
        }

        .history-item:hover {
            background: var(--bg-tertiary);
        }

        .history-item .num {
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--accent-cyan);
            letter-spacing: 4px;
        }

        .history-item .date {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .history-item .delete-btn {
            width: 24px;
            height: 24px;
            border: none;
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
            border-radius: 4px;
            cursor: pointer;
            opacity: 0;
            transition: all 0.2s ease;
        }

        .history-item:hover .delete-btn {
            opacity: 1;
        }

        .history-item .delete-btn:hover {
            background: var(--danger);
            color: white;
        }

        /* ========== æ·»åŠ å·ç  ========== */
        .add-number-form {
            display: flex;
            gap: 10px;
            margin-top: 16px;
        }

        .add-number-form input {
            flex: 1;
            padding: 10px 14px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.95rem;
            outline: none;
            transition: all 0.2s ease;
        }

        .add-number-form input:focus {
            border-color: var(--accent-blue);
        }

        .add-number-form input::placeholder {
            color: var(--text-muted);
        }

        .add-number-form button {
            padding: 10px 16px;
            background: var(--accent-blue);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .add-number-form button:hover {
            background: var(--accent-purple);
        }

        /* ========== çƒ­ç‚¹å·ç  ========== */
        .hotspot-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

        .hotspot-tag {
            padding: 6px 12px;
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 6px;
            font-size: 0.85rem;
            color: var(--danger);
            font-family: 'Monaco', 'Consolas', monospace;
        }

        /* ========== æ•°æ®åŠ è½½çŠ¶æ€ ========== */
        .loading-state {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .loading-state .spinner-large {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border-color);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        /* ========== ç»Ÿè®¡ä¿¡æ¯ ========== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 16px;
        }

        .stat-item {
            background: var(--bg-secondary);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-item .value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-cyan);
        }

        .stat-item .label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* ========== é¿å¼€æœŸæ•°é€‰æ‹© ========== */
        .avoid-period {
            margin-top: 16px;
        }

        .avoid-period label {
            display: block;
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .avoid-period select {
            width: 100%;
            padding: 10px 14px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.95rem;
            outline: none;
            cursor: pointer;
        }

        .avoid-period select:focus {
            border-color: var(--accent-blue);
        }

        /* ========== å“åº”å¼ä¸åˆ†æé¢æ¿ç¾åŒ–ï¼ˆç§»åŠ¨ç«¯ä¼˜åŒ–ï¼‰ ========= */
        .stats-grid {
            grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
            gap: 12px;
        }

        .analysis-content h3, .analysis-content h4 {
            margin: 0 0 8px;
        }

        .analysis-recommendation .rec-item {
            display: inline-block;
            margin-right: 8px;
            padding: 6px 8px;
            border-radius: 6px;
            background: var(--bg-tertiary);
            font-family: monospace;
            color: var(--accent-cyan);
            font-weight: 600;
            white-space: nowrap;
        }

        .analysis-recommendation .rec-item small { color: var(--text-secondary); font-weight: 400; margin-left: 6px; }

        @media (max-width: 640px) {
            .stat-item .value { font-size: 1.25rem; }
            .stats-grid { gap: 8px; }
            .analysis-recommendation .rec-item { display: block; margin-bottom: 8px; white-space: normal; }
            #analysisContent { font-size: 0.95rem; }
            .analysis-content { padding: 6px; }
            .analysis-grid-2 { grid-template-columns: 1fr; }
        }

        /* ========== é”™è¯¯æç¤º ========== */
        .error-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            background: var(--danger);
            color: white;
            border-radius: 8px;
            font-size: 0.9rem;
            z-index: 1000;
            animation: slideIn 0.3s ease;
            display: none;
        }

        .error-toast.show {
            display: block;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* ========== åŸç†è¯´æ˜ ========== */
        .principle-text {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.7;
            margin-top: 12px;
        }

        .principle-text strong {
            color: var(--accent-cyan);
        }

        /* ========== åˆ·æ–°æŒ‰é’® ========== */
        .refresh-btn {
            padding: 8px 16px;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-left: auto;
        }

        .refresh-btn:hover {
            border-color: var(--accent-blue);
            color: var(--accent-blue);
        }

        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
        }

        .card-header .card-title {
            margin-bottom: 0;
        }

        /* ========== å®Œæ•´å¼€å¥–è®°å½•è¡¨æ ¼æ ·å¼ ========== */
        .full-table-section .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            max-width: 100%;
        }

        .full-history-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--bg-secondary);
        }

        .full-history-table th,
        .full-history-table td {
            padding: 12px;
            text-align: left;
            color: var(--text-primary);
            border-bottom: 1px solid var(--border-color);
            font-size: 0.9rem;
            white-space: nowrap;
        }

        @media (max-width: 768px) {
            .full-history-table th,
            .full-history-table td {
                padding: 10px;
                font-size: 0.82rem;
            }

            .full-table-section .table-container {
                max-height: 420px;
            }
        }

        /* æ›´å°å±å¹•ï¼šä¿ç•™è¡¨æ ¼ç»“æ„ï¼Œå…è®¸æ¨ªå‘æ»šåŠ¨ä»¥ä¿æŒåˆ—çš„ä¸€è‡´æ€§ */
        @media (max-width: 480px) {
            .full-history-table th,
            .full-history-table td {
                padding: 8px;
                font-size: 0.78rem;
                white-space: nowrap;
            }
            .full-table-section .table-container {
                max-height: 520px;
                -webkit-overflow-scrolling: touch;
            }
        }

        /* åˆ†æåŒºï¼šç¡®ä¿å’Œå€¼/å¤§ä¼—æ˜¾ç¤ºè‡ªåŠ¨æ¢è¡Œä»¥é˜²æº¢å‡º */
        .sum-analysis-wrap, .popular-wrap { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
        .sum-analysis-wrap > div, .popular-wrap > span { flex: 0 1 auto; }
        .analysis-recommendation .rec-item { max-width: 100%; word-break: break-word; }
        .hotspot-tag { max-width: 100%; word-break: break-word; }
        @media (max-width: 640px) { .sum-analysis-wrap > div, .popular-wrap > span { flex: 0 1 48%; } }

        /* å°ç»„ä»¶è¡¥å……æ ·å¼ï¼šå¯¹å­å·æ¯è¡Œ 4 ä¸ªï¼Œé©¬å°”å¯å¤«å›¾å®¹å™¨è°ƒæ•´ï¼Œæç¤ºæ¡† */
        .pair-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:8px; }
        .pair-item { padding:8px; border-radius:6px; background:var(--bg-tertiary); text-align:center; font-family:monospace; }
        #markovGraph svg { width:100%; height:100%; }
        #markovTooltip { pointer-events:none; }

        /* å›¾è¡¨å·¥å…·æ¡ä¸å…¨å±/ç¼©æ”¾æ ·å¼ï¼ˆç§»åŠ¨ç«¯å‹å¥½ï¼‰ */
        .chart-toolbar { display:flex; gap:8px; justify-content:flex-end; align-items:center; }
        .chart-btn { background:transparent; border:1px solid var(--border-color); color:var(--text-secondary); padding:6px 8px; border-radius:6px; cursor:pointer; font-size:0.9rem; }
        .chart-btn:hover { border-color:var(--accent-blue); color:var(--accent-blue); }
        .chart-fullscreen { position:fixed !important; inset:8px !important; z-index:2200 !important; background:var(--bg-primary) !important; border-radius:10px !important; padding:12px !important; box-shadow:0 20px 60px rgba(0,0,0,0.6) !important; }
        .chart-fullscreen svg, .chart-fullscreen canvas { width:100% !important; height:100% !important; }
        .chart-zoomed { transform-origin: center center; transition: transform 0.15s ease; }
        .input-error { animation: shake 0.45s; border-color: var(--danger) !important; }
        @keyframes shake { 10%, 90% { transform: translateX(-1px); } 20%, 80% { transform: translateX(2px); } 30%, 50%, 70% { transform: translateX(-4px); } 40%, 60% { transform: translateX(4px); } }

        @media (max-width: 640px) { .pair-grid { grid-template-columns:repeat(2,1fr); } .chart-fullscreen { inset:4px !important; padding:8px !important; } }

        .load-more {
            padding: 10px 16px;
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            border-radius: 8px;
            cursor: pointer;
        }

        .load-more:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <!-- é”™è¯¯æç¤º -->
    <div class="error-toast" id="errorToast"></div>

    <div class="container">
        <!-- å¤´éƒ¨ -->
        <header>
            <h1>åä¹Œåˆä¹‹ä¼— Â· æ’åˆ—ä¸‰ç»„é€‰6ç­–ç•¥ç”Ÿæˆå™¨</h1>
            <p class="subtitle">ç”¨æ•°å­¦é¿å¼€äººç¾¤ï¼Œç”¨ç†æ€§èµ¢å¾—ä½“éªŒ</p>
            <span class="badge">åŸºäºè¡Œä¸ºé‡‘èå­¦ä¸åšå¼ˆè®º</span>
        </header>

        <!-- ä¸»ä»ªè¡¨ç›˜ -->
        <div class="dashboard">
            <!-- ä¸»å†…å®¹åŒº -->
            <main class="main-content">
                <!-- ç­–ç•¥é€‰æ‹© -->
                <section class="card">
                    <h2 class="card-title">
                        <span class="icon">âš¡</span>
                        é€‰æ‹©ç­–ç•¥å¼•æ“
                    </h2>
                    <div class="strategy-grid">
                        <div class="strategy-card active" data-strategy="math">
                            <h3>æ•°å­¦å‡åŒ€åˆ†å¸ƒ</h3>
                            <p>åŸºäºå’Œå€¼ã€è·¨åº¦ã€å¥‡å¶æ¯”ã€å¤§å°æ¯”å››ç»´å‡åŒ€åˆ†å¸ƒï¼Œç”Ÿæˆå½¼æ­¤å·®å¼‚åŒ–çš„å·ç ç»„åˆã€‚</p>
                            <span class="tag">æ¨è Â· ç†æ€§æ´¾</span>
                        </div>
                        <div class="strategy-card" data-strategy="culture">
                            <h3>æ–‡åŒ–é¿å¼€ç­–ç•¥</h3>
                            <p>ä¸»åŠ¨é¿å¼€å‰åˆ©æ•°å­—6ã€8ã€9ï¼Œä¼˜å…ˆä½¿ç”¨0ã€2ã€5ã€7ç­‰"ä¸­æ€§"æ•°å­—ï¼Œç”Ÿæˆè§†è§‰ä¸Š"ä¸ç¾è§‚"çš„ç»„åˆã€‚</p>
                            <span class="tag">åç›´è§‰æ´¾</span>
                        </div>
                        <div class="strategy-card" data-strategy="cold">
                            <h3>å†·åƒ»è¶‹åŠ¿ç­–ç•¥</h3>
                            <p>æ·±åº¦åˆ†æè¿‘æœŸå¼€å¥–ï¼Œæœ€å¤§ç¨‹åº¦é¿å¼€çƒ­å·ï¼Œé€‰æ‹©å‡ºç°é¢‘ç‡æœ€ä½çš„æ•°å­—ç»„åˆã€‚</p>
                            <span class="tag">æ•°æ®æ´¾</span>
                        </div>
                        <div class="strategy-card" data-strategy="hot">
                            <h3>è¿½çƒ­é¿å†·ç­–ç•¥</h3>
                            <p>é¡ºåŠ¿è€Œä¸ºï¼Œå°†è¿‘æœŸçƒ­ç ä½œä¸ºæ ¸å¿ƒï¼Œç»„åˆç”Ÿæˆå·ç ï¼Œç¡®ä¿å’Œå€¼è½åœ¨çƒ­åŒºã€‚</p>
                            <span class="tag">è¶‹åŠ¿æ´¾</span>
                        </div>
                        <div class="strategy-card" data-strategy="coldreturn">
                            <h3>èµŒå†·å›å½’ç­–ç•¥</h3>
                            <p>åŸºäºæ¦‚ç‡å¹³å‡å¾‹ï¼Œé€‰ç”¨é•¿æœŸé—æ¼çš„å†·ç ï¼Œæ­é…ä¸­æ€§ç ç»„åˆã€‚</p>
                            <span class="tag">é€†åŠ¿åšå¼ˆ</span>
                        </div>
                        <div class="strategy-card" data-strategy="precision">
                            <h3>ç²¾ç¡®é€†å‘ç­–ç•¥</h3>
                            <p>é¿å¼€å¯¼è‡´ç»„é€‰6å¥–é‡‘æœ€ä½çš„"å¤§ä¼—å·"ï¼Œç›´æ¥ä¸å¤§ä¼—èµ„é‡‘å¯¹èµŒã€‚</p>
                            <span class="tag">èµ„é‡‘åšå¼ˆæ´¾</span>
                        </div>
                    </div>

                    <!-- åˆ†ææœŸæ•°é€‰æ‹© -->
                    <div class="options-row" style="margin-top: 20px;">
                        <div style="flex: 1;">
                            <label style="display: block; font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 8px;">åˆ†ææœŸæ•°ï¼š</label>
                            <select id="analysisPeriods" style="width: 100%; padding: 10px 14px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 0.95rem; outline: none; cursor: pointer;">
                                <option value="10">æœ€è¿‘ 10 æœŸ</option>
                                <option value="30">æœ€è¿‘ 30 æœŸ</option>
                                <option value="50" selected>æœ€è¿‘ 50 æœŸ</option>
                                <option value="100">æœ€è¿‘ 100 æœŸ</option>
                                <option value="200">æœ€è¿‘ 200 æœŸ</option>
                                <option value="500">æœ€è¿‘ 500 æœŸ</option>
                            </select>
                        </div>
                        <div style="flex: 1;">
                            <label style="display: block; font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 8px;">é¿å¼€æœ€è¿‘å¼€å¥–å·ç ï¼š</label>
                            <select id="avoidPeriods" style="width: 100%; padding: 10px 14px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 0.95rem; outline: none; cursor: pointer;">
                                <option value="20">æœ€è¿‘ 20 æœŸ</option>
                                <option value="30" selected>æœ€è¿‘ 30 æœŸ</option>
                                <option value="50">æœ€è¿‘ 50 æœŸ</option>
                                <option value="100">æœ€è¿‘ 100 æœŸ</option>
                                <option value="150">æœ€è¿‘ 150 æœŸ</option>
                                <option value="200">æœ€è¿‘ 200 æœŸ</option>
                            </select>
                        </div>
                    </div>

                    <!-- é«˜çº§é€‰é¡¹ -->
                    <div class="options-row">
                        <label class="checkbox-item">
                            <input type="checkbox" id="strictMode">
                            <span class="checkmark"></span>
                            <span>ã€ä¸¥æ ¼æ¨¡å¼ã€‘å¼ºåˆ¶é¿å¼€æ‰€æœ‰è¿‘æœŸå·ç æ•°å­—</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="aggressiveMode">
                            <span class="checkmark"></span>
                            <span>ã€æ¿€è¿›æ¨¡å¼ã€‘å…è®¸åŒ…å«ä¸€ä¸ª"4"</span>
                        </label>
                    </div>
                </section>

                <!-- ç”ŸæˆæŒ‰é’® -->
                <button class="generate-btn" id="generateBtn">
                    <span class="spinner"></span>
                    ç”Ÿæˆæˆ‘çš„ä¸‰æ³¨ç­–ç•¥å·ç 
                </button>

                <!-- ç»“æœå±•ç¤ºåŒº -->
                <section class="results-section" id="resultsSection">
                    <div class="card">
                        <h2 class="card-title">
                            <span class="icon">ğŸ¯</span>
                            ç­–ç•¥ç”Ÿæˆç»“æœ
                        </h2>
                        <div class="results-grid" id="resultsGrid">
                            <!-- åŠ¨æ€ç”Ÿæˆ -->
                        </div>

                        <!-- å¤§å¸ˆæ´å¯Ÿ -->
                        <div class="insight-box">
                            <p class="quote" id="insightQuote">"å¤§ä¼—è¿½é€è§„å¾‹ï¼Œè€ŒçœŸæ­£çš„éšæœºæ€§å¾€å¾€é¢ç›®å¯æ†ã€‚"</p>
                            <p class="author">â€” åä¹Œåˆä¹‹ä¼—ç­–ç•¥ç³»ç»Ÿ</p>
                        </div>
                    </div>
                </section>
            </main>

            <!-- ä¾§è¾¹æ  -->
            <aside class="sidebar">
                <!-- è¿‘æœŸå¼€å¥– -->
                <article class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <span class="icon">ğŸ“Š</span>
                            è¿‘æœŸå¼€å¥–è®°å½•
                        </h3>
                        <button class="refresh-btn" id="refreshBtn">åˆ·æ–°æ•°æ®</button>
                        <button class="refresh-btn" id="exportBtn">ä¿å­˜ä¸ºå•æ–‡ä»¶</button>
                    </div>
                    <div class="history-list" id="historyList">
                        <div class="loading-state">
                            <div class="spinner-large"></div>
                            <p>æ­£åœ¨è·å–å¼€å¥–æ•°æ®...</p>
                        </div>
                    </div>

                    
                    <div class="add-number-form">
                        <input type="text" id="newNumber" placeholder="æ‰‹åŠ¨æ·»åŠ å·ç  (å¦‚: 123)" maxlength="3">
                        <button id="addNumberBtn">æ·»åŠ </button>
                    </div>
                </article>

                <!-- ç»Ÿè®¡ä¿¡æ¯ -->
                <article class="card">
                    <h3 class="card-title">
                        <span class="icon">ğŸ“ˆ</span>
                        æ•°å­—çƒ­åº¦åˆ†æ
                    </h3>
                    <div class="stats-grid" id="statsGrid">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </article>

                <!-- çƒ­ç‚¹å·ç  -->
                <article class="card">
                    <h3 class="card-title">
                        <span class="icon">ğŸš«</span>
                        åº”é¿å¼€çš„çƒ­ç‚¹å·ç 
                    </h3>
                    <div class="hotspot-grid" id="hotspotGrid">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </article>
            </aside>
        </div>

        <!-- æ•°æ®åˆ†æåŒºåŸŸ -->
        <section class="card" id="analysisSection" style="margin-top: 24px; display: none;">
            <h2 class="card-title">
                <span class="icon">ğŸ“Š</span>
                æ•°æ®åˆ†ææŠ¥å‘Š
            </h2>
            <div id="analysisContent" style="margin-top: 20px;">
                <!-- åŠ¨æ€ç”Ÿæˆæ•°æ®åˆ†æè¡¨æ ¼ -->
            </div>
        </section>

        <!-- å®Œæ•´å¼€å¥–è®°å½•è¡¨æ ¼ï¼ˆåˆ†é¡µ / æ— é™åŠ è½½ï¼‰ -->
        <!-- è¿‘30æœŸèµ°åŠ¿ï¼ˆèµ°åŠ¿å›¾ + èµ°åŠ¿åˆ†æï¼‰ -->
        <section class="card" id="trendSection" style="margin-top: 12px;">
            <h2 class="card-title">
                <span class="icon">ğŸ“ˆ</span>
                è¿‘30æœŸèµ°åŠ¿ä¸åˆ†æ
            </h2>
            <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:flex-start;">
                <div style="flex:1;min-width:260px;">
                    <div class="chart-toolbar" style="margin-bottom:8px;">
                        <button class="chart-btn" data-target="#trendChart" data-action="fullscreen">ğŸ” å…¨å±</button>
                        <button class="chart-btn" data-target="#trendChart" data-action="zoom-in">ï¼‹ æ”¾å¤§</button>
                        <button class="chart-btn" data-target="#trendChart" data-action="zoom-out">ï¼ ç¼©å°</button>
                        <button class="chart-btn" data-target="#trendChart" data-action="reset">â†º å¤ä½</button>
                    </div>
                    <canvas id="trendChart" style="width:100%;height:260px;background:var(--bg-secondary);border-radius:8px;padding:6px;"></canvas>
                </div>
                <div style="width:340px;">
                    <div style="font-weight:700;margin-bottom:6px;color:var(--text-primary);">èµ°åŠ¿åˆ†æ</div>
                    <div id="trendAnalysis" style="color:var(--text-secondary);font-size:0.95rem;line-height:1.5;">åŠ è½½ä¸­...</div>
                </div>
            </div>
        </section>

        <section class="card full-table-section" id="fullTableSection" style="margin-top: 24px;">
            <h2 class="card-title">
                <span class="icon">ğŸ“š</span>
                å®Œæ•´å¼€å¥–è®°å½•ï¼ˆè¿‘500æœŸï¼‰
            </h2>
            <div class="table-container" id="fullTableContainer" style="max-height: 420px; overflow-y: auto;">
                <table class="full-history-table" id="fullHistoryTable">
                    <thead>
                        <tr>
                            <th>æœŸå·</th>
                            <th>æ—¥æœŸ</th>
                            <th>å·ç </th>
                            <th>ç›´é€‰ æ³¨æ•°</th>
                            <th>ç›´é€‰ å¥–é‡‘</th>
                            <th>ç»„é€‰3 æ³¨æ•°</th>
                            <th>ç»„é€‰3 å¥–é‡‘</th>
                            <th>ç»„é€‰6 æ³¨æ•°</th>
                            <th>ç»„é€‰6 å¥–é‡‘</th>
                            <th>é”€å”®é¢</th>
                            <th>å…¬å‘Š</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div style="display:flex; justify-content:center; margin-top:12px;">
                <button class="load-more" id="loadMoreBtn">åŠ è½½æ›´å¤š</button>
            </div>
        </section>
    </div>

    <script>
        /**
         * ========================================
         * åä¹Œåˆä¹‹ä¼— Â· æ’åˆ—ä¸‰ç»„é€‰6ç­–ç•¥ç”Ÿæˆå™¨
         * æ ¸å¿ƒç®—æ³•ä¸äº¤äº’é€»è¾‘
         * ========================================
         */

        // ========== å…¨å±€é…ç½®ä¸æ•°æ® ==========
        const CONFIG = {
            // API é…ç½®
            API_URL: 'https://webapi.sporttery.cn/gateway/lottery/getHistoryPageListV1.qry?gameNo=35&provinceId=0&pageSize=100&isVerify=1&pageNo=1&termLimits=100',

            // è¯´æ˜ï¼šå‰ç«¯ä»…ç›´æ¥è¯·æ±‚å®˜æ–¹æ¥å£ï¼ˆè‹¥å­˜åœ¨ CORS é—®é¢˜ï¼Œè¯·ä½¿ç”¨å•æ–‡ä»¶å¯¼å…¥æˆ–åœ¨æœåŠ¡å™¨/Worker å±‚åšä»£ç†ï¼‰
            // å‰ç«¯ä¸å†ç»´æŠ¤è‡ªåŠ¨ä»£ç†é…ç½®ä»¥ä¿æŒä»£ç ç²¾ç®€ä¸å¯å®¡è®¡æ€§


            // çƒ­ç‚¹å·ç åº“ï¼ˆå¤§ä¼—é«˜é¢‘é€‰æ‹©ï¼‰
            HOTSPOT_NUMBERS: [
                // é”®ç›˜ç»„åˆ
                '123', '234', '345', '456', '567', '678', '789',
                '321', '432', '543', '654', '765', '876', '987',
                '147', '258', '369', '741', '852', '963',
                '159', '357', '753', '951',
                '123', '456', '789',
                // å‰åˆ©æ•°å­—ç»„åˆ
                '666', '888', '999', '168', '268', '368', '518', '618', '688', '818', '868', '886', '888',
                '066', '088', '068', '086', '006', '008',
                '116', '118', '166', '188', '668', '698', '689', '896', '869',
                // é¡ºå­ä¸è±¹å­
                '000', '111', '222', '333', '444', '555', '777',
                '012', '890',
                // ç”Ÿæ—¥ç›¸å…³é«˜é¢‘ï¼ˆæœˆä»½01-12ï¼Œæ—¥æœŸ01-31çš„å¸¸è§ç»„åˆï¼‰
                '101', '102', '103', '104', '105', '106', '107', '108', '109', '110', '111', '112',
                '201', '202', '203', '204', '205', '206', '207', '208', '209', '210', '211', '212',
                '301', '302', '303', '304', '305', '306', '307', '308', '309', '310', '311', '312',
                '120', '121', '122', '123', '124', '125', '126', '127', '128', '129', '130', '131',
                '520', '521', '502', '512', // ç½‘ç»œæµè¡Œ
                '214', '314', '514', '714', '914', // æƒ…äººèŠ‚ç›¸å…³
            ],

            // å¤§å¸ˆæ´å¯Ÿè¯­å½•
            INSIGHTS: [
                "å¤§ä¼—è¿½é€è§„å¾‹ï¼Œè€ŒçœŸæ­£çš„éšæœºæ€§å¾€å¾€é¢ç›®å¯æ†ã€‚",
                "ä½ é¿å¼€çš„ä¸æ˜¯æ•°å­—ï¼Œæ˜¯äººç¾¤çš„éç†æ€§å…±è¯†ã€‚",
                "åœ¨æ¦‚ç‡é¢å‰ï¼Œæ‰€æœ‰æ•°å­—ç”Ÿè€Œå¹³ç­‰ï¼Œä½†é€‰æ‹©è€…å´å¹¶éå¦‚æ­¤ã€‚",
                "èªæ˜çš„ç­–ç•¥ä¸æ˜¯é¢„æµ‹ä¸­å¥–å·ç ï¼Œè€Œæ˜¯é¿å¼€æ‹¥æŒ¤çš„é€‰æ‹©ã€‚",
                "å½“æ‰€æœ‰äººéƒ½åœ¨è¿½é€å¹¸è¿æ•°å­—æ—¶ï¼Œä½ é€‰æ‹©äº†æ•°å­¦ã€‚",
                "åšå¼ˆè®ºå‘Šè¯‰æˆ‘ä»¬ï¼šæœ€ä¼˜ç­–ç•¥å¾€å¾€æ˜¯åç›´è§‰çš„ã€‚",
                "ç‹¬ç«‹æ€è€ƒçš„ä»£ä»·æ˜¯å­¤ç‹¬ï¼Œä½†å›æŠ¥æ˜¯å·®å¼‚åŒ–çš„å¯èƒ½ã€‚",
                "ç»Ÿè®¡å­¦å®¶ä¸ä¿¡å‘½è¿ï¼Œä»–ä»¬ç›¸ä¿¡åˆ†å¸ƒã€‚",
                "é¿å¼€äººç¾¤ï¼Œä¸æ˜¯ä¸ºäº†ç‰¹ç«‹ç‹¬è¡Œï¼Œè€Œæ˜¯ä¸ºäº†æ•°å­¦æ•ˆç‡ã€‚",
                "æ¯ä¸€ä¸ªçƒ­é—¨å·ç èƒŒåï¼Œéƒ½æœ‰æ— æ•°äººåœ¨åˆ†æ‘ŠæœŸæœ›å€¼ã€‚"
            ]
        };

        // å…¨å±€çŠ¶æ€
        let state = {
            historyNumbers: [],      // è¿‘æœŸå¼€å¥–å·ç 
            selectedStrategy: 'math', // å½“å‰ç­–ç•¥
            isLoading: false
        };

        // ========== å·¥å…·å‡½æ•° ==========

        /**
         * æ˜¾ç¤ºé”™è¯¯æç¤º
         */
        function showError(message) {
            const toast = $('#errorToast');
            toast.text(message).addClass('show');
            setTimeout(() => toast.removeClass('show'), 3000);
        }

        /**
         * è§£æå·ç ä¸ºæ•°ç»„
         */
        function parseNumber(num) {
            return num.toString().padStart(3, '0').split('').map(Number);
        }

        /**
         * è®¡ç®—ç»„é€‰6çš„æ’åºå½¢å¼ï¼ˆå‡åºï¼‰
         */
        function sortNumber(num) {
            return parseNumber(num).sort((a, b) => a - b).join('');
        }

        /**
         * åˆ¤æ–­æ˜¯å¦ä¸ºç»„é€‰6ï¼ˆä¸‰ä¸ªæ•°å­—éƒ½ä¸åŒï¼‰
         */
        function isZuxuan6(num) {
            const digits = parseNumber(num);
            return new Set(digits).size === 3;
        }

        /**
         * è®¡ç®—å’Œå€¼
         */
        function calcSum(num) {
            return parseNumber(num).reduce((a, b) => a + b, 0);
        }

        /**
         * è®¡ç®—è·¨åº¦
         */
        function calcSpan(num) {
            const digits = parseNumber(num);
            return Math.max(...digits) - Math.min(...digits);
        }

        /**
         * è®¡ç®—å¥‡å¶æ¯”
         */
        function calcOddEven(num) {
            const digits = parseNumber(num);
            const odd = digits.filter(d => d % 2 === 1).length;
            return `${odd}:${3 - odd}`;
        }

        /**
         * è®¡ç®—å¤§å°æ¯”ï¼ˆ5-9ä¸ºå¤§ï¼Œ0-4ä¸ºå°ï¼‰
         */
        function calcBigSmall(num) {
            const digits = parseNumber(num);
            const big = digits.filter(d => d >= 5).length;
            return `${big}:${3 - big}`;
        }

        /**
         * æ£€æŸ¥æ˜¯å¦ä¸ºç­‰å·®æ•°åˆ—
         */
        function isArithmeticSequence(num) {
            const digits = parseNumber(num).sort((a, b) => a - b);
            return (digits[1] - digits[0]) === (digits[2] - digits[1]);
        }

        /**
         * æ£€æŸ¥æ˜¯å¦åŒ…å«çƒ­ç‚¹ç»„åˆ
         */
        function isHotspot(num) {
            const sorted = sortNumber(num);
            return CONFIG.HOTSPOT_NUMBERS.some(hot => sortNumber(hot) === sorted);
        }

        /**
         * è·å–è¿‘æœŸå·ç ä¸­å„æ•°å­—å‡ºç°é¢‘ç‡
         * ä¿®å¤ï¼šæ”¯æŒä¼ å…¥å·²æˆªå–çš„åˆ—è¡¨æˆ–ä¼ å…¥å®Œæ•´åˆ—è¡¨å¹¶ç”± limit é™åˆ¶ï¼Œé¿å…åœ¨åˆ†ææ—¶å‡ºç°é”™è¯¯ç»Ÿè®¡
         */
        function getDigitFrequency(historyList, limit) {
            const freq = Array(10).fill(0);
            const list = Array.isArray(historyList) ? (limit ? historyList.slice(0, limit) : historyList) : [];
            list.forEach(item => {
                parseNumber(item.number).forEach(d => freq[d]++);
            });
            return freq;
        }

        // ========== API æ•°æ®è·å– ==========

        /**
         * ä»å®˜æ–¹APIè·å–æŒ‡å®šé¡µæ•°çš„å¼€å¥–æ•°æ®
         */


        /**
         * ä»å®˜æ–¹APIè·å–è¿‘æœŸå¼€å¥–æ•°æ®ï¼ˆæ”¯æŒåˆ†é¡µè·å–å¤šæœŸï¼‰
         */
        async function fetchHistoryData(totalPages = 5, pageSize = 100) {
            // é»˜è®¤åªè¿›è¡Œ 5 æ¬¡è¯·æ±‚ï¼Œæ¯æ¬¡è¯·æ±‚ pageSize æ¡ï¼ˆå»ºè®® 100ï¼‰ï¼Œåˆè®¡è¿‘ 500 æœŸï¼Œå‡å°‘å¤šæ¬¡åŠ è½½å’ŒæœåŠ¡å™¨å‹åŠ›
            state.isLoading = true;
            $('#historyList').html('<div class="loading-state"><div class="spinner-large"></div><p>æ­£åœ¨è·å–å¼€å¥–æ•°æ®...</p></div>');

            // å¦‚æœå‹¾é€‰äº†â€œä½¿ç”¨å†…ç½®æ•°æ®â€ï¼Œæˆ–å­˜åœ¨æœ¬åœ°å­˜å‚¨æ•°æ®ï¼Œä¼˜å…ˆä½¿ç”¨æœ¬åœ°/å†…ç½®æ•°æ®
            const useLocal = $('#useLocalData').length && $('#useLocalData').is(':checked');
            // å¦‚æœé¡µé¢å†…åµŒäº† PRELOADED_HISTORYï¼ˆä¾‹å¦‚ï¼šç”¨æˆ·ç”Ÿæˆçš„å•æ–‡ä»¶ HTMLï¼‰ï¼Œä¼˜å…ˆä½¿ç”¨å®ƒä»¥æ”¯æŒç¦»çº¿è®¿é—®
            if (window.PRELOADED_HISTORY && Array.isArray(window.PRELOADED_HISTORY) && window.PRELOADED_HISTORY.length) {
                state.historyNumbers = JSON.parse(JSON.stringify(window.PRELOADED_HISTORY)).sort((a, b) => parseInt(b.period || 0) - parseInt(a.period || 0));
                state.isLoading = false;
                $('#historyList').html('');
                renderHistoryList();
                renderStats();
                // æ¸²æŸ“è¿‘30æœŸèµ°åŠ¿å›¾ï¼ˆè‹¥æœ‰ï¼‰
                try { renderTrendChart(30); } catch(e) { /* ignore */ }
                // è®°å½•ç”¨æˆ·åˆ†ææœŸæ•°æ„å›¾å¹¶åœ¨ç•Œé¢ä¸Šè®¾ç½®ï¼ˆæœ€å¤š500æœŸï¼‰å¹¶å…ˆç”Ÿæˆç­–ç•¥ç»“æœ
                state.requestedAnalysisTarget = parseInt($('#analysisPeriods').val()) || 100;
                $('#analysisPeriods').val(Math.min(state.requestedAnalysisTarget, state.historyNumbers.length, 500));
                generateAnalysisReport();
                const initResults = generateNumbers(state.selectedStrategy);
                renderResults(initResults);
                setupFullHistoryTable();
                // å¼‚æ­¥æ£€æŸ¥ API æ˜¯å¦æœ‰æ›´æ–°çš„æ•°æ®ï¼›è‹¥æœ‰åˆ™æ›¿æ¢å¹¶é‡æ–°æ¸²æŸ“/åˆ†æï¼ˆæ”¯æŒç¦»çº¿é¡µé¢æ£€æµ‹æ›´æ–°ï¼‰
                (async function checkApiForUpdates() {
                    try {
                        const apiFirst = await fetchHistoryPageRuntime(1, pageSize);
                        if (apiFirst && apiFirst.length) {
                            const apiTop = apiFirst[0].period;
                            const localTop = state.historyNumbers[0] && state.historyNumbers[0].period;
                            if (apiTop && (!localTop || parseInt(apiTop) > parseInt(localTop))) {
                                // åˆå¹¶å¹¶ä¼˜å…ˆä½¿ç”¨ API æœ€æ–°æ•°æ®
                                const unique = new Map();
                                apiFirst.forEach(item => { if (item.period && !unique.has(item.period)) unique.set(item.period, item); });
                                state.historyNumbers = Array.from(unique.values()).concat(state.historyNumbers.filter(i=>!unique.has(i.period))).sort((a,b)=>parseInt(b.period||0)-parseInt(a.period||0));
                                try { localStorage.setItem('anti_crowd_history', JSON.stringify(state.historyNumbers.slice(0,500))); } catch(e){/* ignore */}
                                renderHistoryList();
                                renderStats();
                                $('#analysisPeriods').val(Math.min(state.requestedAnalysisTarget || 100, state.historyNumbers.length, 500));
                                generateAnalysisReport();
                                const refreshed = generateNumbers(state.selectedStrategy);
                                renderResults(refreshed);
                                setupFullHistoryTable();
                                $('#historyList').prepend('<div class="info-note">æ£€æµ‹åˆ°æ›´æ–°æ•°æ®ï¼Œå·²åˆ·æ–°ä¸ºæœ€æ–°å¼€å¥–ï¼ˆæ¥è‡ª APIï¼‰ã€‚</div>');
                            }
                        }
                    } catch (e) {
                        console.warn('æ£€æŸ¥ API æ›´æ–°å¤±è´¥', e);
                    }
                })();
                return true;
            }

                // ä¼˜å…ˆä½¿ç”¨ localStorage ä¸­çš„ç¼“å­˜ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ï¼Œä¾¿äºæœ¬åœ°è¦†ç›–é¡µé¢åæ— éœ€é‡å¤ç²˜è´´
                try {
                    const stored = localStorage.getItem('anti_crowd_history');
                    if (stored) {
                        const parsedStored = JSON.parse(stored);
                        if (Array.isArray(parsedStored) && parsedStored.length) {
                            state.historyNumbers = parsedStored.sort((a, b) => parseInt(b.period || 0) - parseInt(a.period || 0));
                            state.isLoading = false;
                            $('#historyList').html('');
                            renderHistoryList();
                            renderStats();
                            // è®°å½•ç”¨æˆ·åˆ†ææœŸæ•°æ„å›¾å¹¶åœ¨ç•Œé¢ä¸Šè®¾ç½®ï¼ˆæœ€å¤š500æœŸï¼‰å¹¶å…ˆç”Ÿæˆç­–ç•¥ç»“æœ
                            state.requestedAnalysisTarget = parseInt($('#analysisPeriods').val()) || 100;
                            $('#analysisPeriods').val(Math.min(state.requestedAnalysisTarget, state.historyNumbers.length, 500));
                            generateAnalysisReport();
                            const initResults = generateNumbers(state.selectedStrategy);
                            renderResults(initResults);
                            setupFullHistoryTable();
                            // å¼‚æ­¥æ£€æŸ¥ API é¦–é¡µæ˜¯å¦æœ‰æ›´æ–°å¹¶åœ¨å‘ç°æ›´æ–°æ—¶æ›¿æ¢
                            (async function checkApiForUpdatesFromCache(){
                                try {
                                    const apiFirst = await fetchHistoryPageRuntime(1, pageSize);
                                    if (apiFirst && apiFirst.length) {
                                        const apiTop = apiFirst[0].period;
                                        const localTop = state.historyNumbers[0] && state.historyNumbers[0].period;
                                        if (apiTop && (!localTop || parseInt(apiTop) > parseInt(localTop))) {
                                            const unique = new Map();
                                            apiFirst.forEach(item => { if (item.period && !unique.has(item.period)) unique.set(item.period, item); });
                                            state.historyNumbers = Array.from(unique.values()).concat(state.historyNumbers.filter(i=>!unique.has(i.period))).sort((a,b)=>parseInt(b.period||0)-parseInt(a.period||0));
                                            try { localStorage.setItem('anti_crowd_history', JSON.stringify(state.historyNumbers.slice(0,500))); } catch(e){/* ignore */}
                                            renderHistoryList();
                                            renderStats();
                                            $('#analysisPeriods').val(Math.min(state.requestedAnalysisTarget || 100, state.historyNumbers.length, 500));
                                            generateAnalysisReport();
                                            const refreshed = generateNumbers(state.selectedStrategy);
                                            renderResults(refreshed);
                                            setupFullHistoryTable();
                                            $('#historyList').prepend('<div class="info-note">æ£€æµ‹åˆ°æ›´æ–°æ•°æ®ï¼Œå·²åˆ·æ–°ä¸ºæœ€æ–°å¼€å¥–ï¼ˆæ¥è‡ª APIï¼‰ã€‚</div>');
                                        }
                                    }
                                } catch (e) {
                                    console.warn('æ£€æŸ¥ API æ›´æ–°å¤±è´¥', e);
                                }
                            })();
                            return true;
                        }
                    }
                } catch (e) {
                    console.warn('è¯»å– localStorage å¤±è´¥', e);
                }

            // ä½¿ç”¨ fetch è·å–å•é¡µå¹¶æ ‡å‡†åŒ–è¿”å›ï¼ˆå‰ç«¯ç›´æ¥è¯·æ±‚å®˜æ–¹æ¥å£ï¼‰
            /* å·²ç§»é™¤ä»£ç†ç©¿é€ç›¸å…³è¾…åŠ©å‡½æ•°ï¼Œç®€åŒ–ä¸ºç›´æ¥ fetchï¼›å¦‚éœ€ä»£ç†è¯·åœ¨æœåŠ¡ç«¯/Worker å±‚å¤„ç† */

            async function fetchHistoryPageRuntime(pageNo, pageSize) {
                const url = (CONFIG.API_URL || '').replace(/pageNo=\d+/, 'pageNo=' + pageNo).replace(/pageSize=\d+/, 'pageSize=' + pageSize);
                const target = url.replace(/callback=\?/, '');

                // ä»…ä½¿ç”¨ç›´æ¥ fetch æ‹‰å–æ•°æ®ï¼›å¦‚éœ€ä»£ç†è¯·åœ¨æœåŠ¡å™¨/Worker å±‚å¤„ç†

                try {
                    const resp = await fetch(url, {
                        method: 'GET',
                        credentials: 'omit',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    });
                    if (!resp.ok) {
                        const t = await resp.text().catch(() => '');
                        const err = new Error('http_error:' + resp.status + ' ' + resp.statusText + ' ' + (t || '').slice(0,200));
                        err.status = resp.status;
                        throw err;
                    }
                    const data = await resp.json();
                    let list = null;
                    if (Array.isArray(data)) list = data;
                    else if (data.value && Array.isArray(data.value.list)) list = data.value.list;
                    else if (Array.isArray(data.list)) list = data.list;
                    else if (data.data && Array.isArray(data.data.list)) list = data.data.list;
                    else throw new Error('no_list_in_response');
                    return list.map(normalizeApiItem).filter(i => i && i.period && i.number);
                } catch (e) {
                    console.warn('fetchHistoryPageRuntime error', e);
                    if (e && e.message && (e.message.indexOf('567') !== -1 || e.message.indexOf('blocked_by_edgeone') !== -1 || (e.status && e.status === 567))) {
                        throw new Error('blocked_by_edgeone');
                    }
                    throw e;
                }
            }

            try {
                const pageSizeLocal = pageSize;
                const maxRetries = 2;

                // 1) å…ˆæ‹‰å–ç¬¬ä¸€é¡µå¹¶ç«‹å³ä½¿ç”¨ï¼ˆæå‡ä½“éªŒï¼‰
                let firstPageItems = [];
                let attempt = 0;
                while (attempt <= maxRetries) {
                    try {
                        $('#historyList').html(`<div class="loading-state"><div class="spinner-large"></div><p>æ­£åœ¨è·å–å¼€å¥–æ•°æ®... ï¼ˆç¬¬ 1/${totalPages} é¡µï¼‰</p></div>`);
                        firstPageItems = await fetchHistoryPageRuntime(1, pageSizeLocal);
                        break;
                    } catch (err) {
                        attempt++;
                        console.warn('fetch first page failed', 'attempt', attempt, err);
                        if (err && err.message && err.message.indexOf('blocked_by_edgeone') !== -1) throw err;
                        if (attempt > maxRetries) throw err;
                        await new Promise(r => setTimeout(r, 600 * attempt));
                    }
                }

                if (!firstPageItems || firstPageItems.length === 0) throw new Error('æœªè·å–åˆ°ä»»ä½•æ•°æ®');

                // åº”ç”¨ç¬¬ä¸€é¡µæ•°æ®å¹¶ç«‹å³æ¸²æŸ“ä¸åˆ†æ
                const unique = new Map();
                firstPageItems.forEach(item => { if (item.period && !unique.has(item.period)) unique.set(item.period, item); });
                state.historyNumbers = Array.from(unique.values()).sort((a, b) => parseInt(b.period || 0) - parseInt(a.period || 0));

                // ä¿å­˜å¹¶æ³¨å…¥ï¼ˆå…ˆä¿å­˜ç¬¬ä¸€é¡µï¼‰
                try { localStorage.setItem('anti_crowd_history', JSON.stringify(state.historyNumbers.slice(0, 500))); } catch (e) { console.warn('ä¿å­˜ localStorage å¤±è´¥', e); }
                try {
                    const existing = document.getElementById('preloaded-history-script');
                    if (existing) existing.remove();
                    const s = document.createElement('script');
                    s.id = 'preloaded-history-script';
                    s.type = 'text/javascript';
                    s.textContent = 'window.PRELOADED_HISTORY = ' + JSON.stringify(state.historyNumbers.slice(0,500)) + ';';
                    document.body.appendChild(s);
                } catch (ee) { console.warn('æ³¨å…¥ PRELOADED_HISTORY åˆ°é¡µé¢å¤±è´¥', ee); }

                $('#historyList').html('');
                renderHistoryList();
                renderStats();
                // è®°å½•ç”¨æˆ·åŸå§‹é€‰æ‹©ï¼ˆç”¨äºåå°åŠ è½½å®Œæˆåå†³å®šæ˜¯å¦é‡æ–°åˆ†æï¼‰
                const requested = parseInt($('#analysisPeriods').val()) || 100;
                state.requestedAnalysisTarget = requested;
                // å°†ç•Œé¢é€‰æ‹©è®¾ä¸ºå½“å‰å¯ç”¨çš„æœŸæ•°ï¼ˆä¸ä¸¢å¤±ç”¨æˆ·æ„å›¾ï¼‰
                $('#analysisPeriods').val(Math.min(requested, state.historyNumbers.length, 500));
                generateAnalysisReport();
                const initResults = generateNumbers(state.selectedStrategy);
                renderResults(initResults);
                setupFullHistoryTable();

                // 2) åå°æŒ‰é¡µé¡ºåºåŠ è½½å‰©ä½™é¡µé¢å¹¶è¿½åŠ åˆ° stateï¼ˆä¸é˜»å¡åˆå§‹åˆ†æï¼‰
                (async function fetchRemainingPages() {
                    let allUnique = new Map(state.historyNumbers.map(i=>[i.period, i]));
                    for (let pageNo = 2; pageNo <= totalPages; pageNo++) {
                        let attemptP = 0;
                        let pageItems = [];
                        while (attemptP <= maxRetries) {
                            try {
                                // åœ¨åå°é™é»˜åŠ è½½ï¼ŒUI å¯é€‰æ‹©æ˜¾ç¤ºå°å¹…æç¤º
                                pageItems = await fetchHistoryPageRuntime(pageNo, pageSizeLocal);
                                break;
                            } catch (err) {
                                attemptP++;
                                console.warn('background fetch page failed', pageNo, 'attempt', attemptP, err);
                                if (err && err.message && err.message.indexOf('blocked_by_edgeone') !== -1) { throw err; }
                                if (attemptP > maxRetries) { break; }
                                await new Promise(r => setTimeout(r, 600 * attemptP));
                            }
                        }

                        if (pageItems && pageItems.length) {
                            pageItems.forEach(item => { if (item.period && !allUnique.has(item.period)) allUnique.set(item.period, item); });

                            // å°†è¿½åŠ çš„æ•°æ®åˆå¹¶å› stateï¼Œå¹¶ä¿ç•™æœ€æ–° 500 æ¡
                            state.historyNumbers = Array.from(allUnique.values()).sort((a,b)=> parseInt(b.period||0) - parseInt(a.period||0));
                            try { localStorage.setItem('anti_crowd_history', JSON.stringify(state.historyNumbers.slice(0,500))); } catch(e) { console.warn('ä¿å­˜ localStorage å¤±è´¥', e); }

                            // åˆ·æ–°çŸ­åˆ—è¡¨ä¸ç»Ÿè®¡ï¼ˆå³æ—¶æ›´æ–°è¿‘æœŸå¼€å¥–è®°å½•ï¼‰ï¼Œå¹¶è®©å®Œæ•´è¡¨æ ¼å¯ç»§ç»­åŠ è½½æ–°é¡µ
                            renderHistoryList();
                            renderStats();

                            if (state.fullTable) {
                                // æ›´æ–°æ€»é¡µæ•°å¹¶å°½é‡è‡ªåŠ¨åŠ è½½ä¸‹ä¸€é¡µåˆ°è¡¨æ ¼ä»¥ä¾¿å¯è§ï¼ˆç”¨æˆ·ä½“éªŒå‹å¥½ï¼‰
                                state.fullTable.totalPages = Math.ceil((state.historyNumbers || []).length / state.fullTable.pageSize);
                                if (!state.fullTable.loading && state.fullTable.currentPage < state.fullTable.totalPages) {
                                    loadNextTablePage();
                                }
                            }
                        }

                        // å°å»¶è¿Ÿï¼Œé¿å…è¿‡å¿«è¿ç»­è¯·æ±‚
                        await new Promise(r => setTimeout(r, 200));
                    }

                    // æ‰€æœ‰é¡µé¢åŠ è½½å®Œæ¯•åï¼šè‹¥ç”¨æˆ·åŸå…ˆå¸Œæœ›åˆ†æ 500 æœŸå¹¶ä¸”å·²åŠ è½½åˆ° 500 æ¡ï¼Œæ¢å¤é€‰æ‹©å¹¶é‡æ–°è¿è¡Œåˆ†æ
                    $('#backgroundLoadNotice').remove();
                    if (state.requestedAnalysisTarget && state.historyNumbers.length >= state.requestedAnalysisTarget) {
                        $('#analysisPeriods').val(state.requestedAnalysisTarget);
                        generateAnalysisReport();
                        const refreshed = generateNumbers(state.selectedStrategy);
                        renderResults(refreshed);
                    }
                })();

                // æ˜¾ç¤ºåå°åŠ è½½æç¤ºï¼ˆéé˜»å¡ï¼‰
                if (totalPages > 1) {
                    $('#historyList').append('<div id="backgroundLoadNotice" style="padding:8px;color:var(--text-secondary);font-size:0.85rem;">æ­£åœ¨åå°åŠ è½½æ›´å¤šè®°å½•â€¦</div>');
                }

                return true;
            } catch (error) {
                console.error('è·å–å¼€å¥–æ•°æ®å¤±è´¥:', error);

                $('#historyList').html('<div class="loading-state"><p style="color: var(--danger);">è·å–æ•°æ®å¤±è´¥ã€‚å¯å°è¯•ä»æœ¬åœ°å¯¼å…¥ JSON æˆ–ä½¿ç”¨å·²ä¿å­˜çš„å•æ–‡ä»¶ç¦»çº¿æ•°æ®ã€‚</p></div>');
                state.historyNumbers = [];
                return false;
            } finally {
                state.isLoading = false;
            }
        }

       

        // ========== æ•°æ®åˆ†æåŠŸèƒ½ ==========

        /**
         * ç”Ÿæˆæ•°æ®åˆ†ææŠ¥å‘Šï¼ˆå«æ¯é¡¹æ¨èä¸æƒé‡æ±‡æ€»ï¼‰
         */
        function generateAnalysisReport() {
            // ä¼˜å…ˆä½¿ç”¨ç•Œé¢å€¼ï¼Œå¦åˆ™é»˜è®¤ 100ï¼ˆæœ€å¤§æ”¯æŒ 500ï¼‰
            let analysisPeriods = parseInt($('#analysisPeriods').val()) || 100;
            analysisPeriods = Math.min(analysisPeriods, state.historyNumbers.length, 500);
            $('#analysisPeriods').val(analysisPeriods);

            const recentData = state.historyNumbers.slice(0, analysisPeriods);

            // é¢„è®¡ç®—ï¼šæ•°å­—çƒ­åº¦ã€å’Œå€¼ã€å¥‡å¶æ¯”ã€å¤§å°æ¯”
            const digitFreq = getDigitFrequency(recentData);
            const digitAnalysis = digitFreq.map((count, digit) => ({
                digit: digit,
                count: count,
                frequency: ((count / (analysisPeriods * 3)) * 100).toFixed(2) + '%'
            })).sort((a, b) => b.count - a.count);

            const sumFreq = {};
            recentData.forEach(item => {
                const sum = calcSum(item.number);
                sumFreq[sum] = (sumFreq[sum] || 0) + 1;
            });
            const sumAnalysis = Object.entries(sumFreq)
                .map(([sum, count]) => ({ sum: parseInt(sum), count: count, frequency: ((count / analysisPeriods) * 100).toFixed(2) + '%' }))
                .sort((a, b) => b.count - a.count);

            const oddEvenFreq = {};
            recentData.forEach(item => {
                const oddEven = calcOddEven(item.number);
                oddEvenFreq[oddEven] = (oddEvenFreq[oddEven] || 0) + 1;
            });
            const oddEvenAnalysis = Object.entries(oddEvenFreq).map(([ratio, count]) => ({ ratio, count, frequency: ((count / analysisPeriods) * 100).toFixed(2) + '%' })).sort((a,b)=>b.count-a.count);

            const bigSmallFreq = {};
            recentData.forEach(item => {
                const bigSmall = calcBigSmall(item.number);
                bigSmallFreq[bigSmall] = (bigSmallFreq[bigSmall] || 0) + 1;
            });
            const bigSmallAnalysis = Object.entries(bigSmallFreq).map(([ratio, count]) => ({ ratio, count, frequency: ((count / analysisPeriods) * 100).toFixed(2) + '%' })).sort((a,b)=>b.count-a.count);

            // å¯¹å­å·ï¼ˆæœ‰ä¸”ä»…æœ‰ä¸¤ä¸ªç›¸åŒæ•°å­—ï¼‰ç»Ÿè®¡ï¼ˆä¾‹å¦‚ï¼š878ã€373ã€255ï¼‰
            const pairFreq = {};
            recentData.forEach(item => {
                const digits = parseNumber(item.number);
                const uniq = new Set(digits);
                if (uniq.size === 2) {
                    pairFreq[item.number] = (pairFreq[item.number] || 0) + 1;
                }
            });
            const pairAnalysis = Object.entries(pairFreq).map(([number, count]) => ({ number, count })).sort((a,b)=>b.count-a.count);

            // æ›¿æ¢ä¹‹å‰çš„å¥–é‡‘åˆ¤æ–­ç­–ç•¥ï¼šä½¿ç”¨å‡ºç°é¢‘ç‡åˆ¤æ–­å¤§ä¼—å·ï¼ˆæ’åˆ—3å¥–é‡‘å›ºå®šï¼‰
            const comboFreq = {};
            recentData.forEach(item => {
                const sorted = sortNumber(item.number);
                comboFreq[sorted] = (comboFreq[sorted] || 0) + 1;
            });
            const popularCombos = Object.entries(comboFreq).map(([number, count]) => ({ number, count })).sort((a,b)=>b.count-a.count).slice(0, 10);

            // ç”Ÿæˆå€™é€‰ç»„åˆå¹¶è®¡ç®—ç‰¹å¾ï¼ˆå…±120ç§ï¼‰
            const combos = getAllZuxuan6Combos().map(c => {
                const freqSum = c.digits.reduce((s,d)=>s + digitFreq[d], 0);
                const occ = comboFreq[c.sorted] || 0;
                return Object.assign({}, c, { freqSum, occurrence: occ, isHotspot: isHotspot(c.number) });
            });

            // æ¨èé€»è¾‘ï¼šæ¯é¡¹è¾“å‡ºæœ€å¤š3ä¸ªæ¨èï¼Œå¹¶èµ‹äºˆæƒé‡ 3/2/1; åŒæ—¶ä¿ç•™å’Œå€¼ï¼ˆè‹¥å­˜åœ¨ï¼‰ä»¥ä¾¿æ˜¾ç¤º
            const recommendations = {};
            function addRec(section, arr) {
                recommendations[section] = arr.slice(0,3).map((item, i) => ({ number: item.number, score: 3 - i, sum: item.sum }));
            }

            // 1. æ•°å­—çƒ­åº¦ï¼ˆæ”¹ä¸ºä¼˜å…ˆåŒ¹é…å¥‡å¶æ¯”ä¸å¤§å°æ¯”ï¼Œå…¶æ¬¡é™åºæ•°å­—çƒ­åº¦ï¼‰
            const topOddEven = oddEvenAnalysis.length ? oddEvenAnalysis[0].ratio : null;
            const topBigSmall = bigSmallAnalysis.length ? bigSmallAnalysis[0].ratio : null;
            let digitCandidates = combos.filter(c => !c.isHotspot && !isRecentNumber(c.number, analysisPeriods) && c.oddEven === topOddEven && c.bigSmall === topBigSmall);
            if (digitCandidates.length === 0) {
                digitCandidates = combos.filter(c => !c.isHotspot && !isRecentNumber(c.number, analysisPeriods) && (c.oddEven === topOddEven || c.bigSmall === topBigSmall));
            }
            if (digitCandidates.length === 0) {
                digitCandidates = combos.filter(c => !c.isHotspot && !isRecentNumber(c.number, analysisPeriods)).sort((a,b)=>b.freqSum - a.freqSum);
            }
            addRec('digitHeat', digitCandidates);

            // 2. å’Œå€¼åˆ†å¸ƒï¼ˆä¼˜å…ˆå’Œå€¼é«˜é¢‘ï¼Œä¼˜å…ˆé€‰æ‹©å‡ºç°æ¬¡æ•°ï¼ˆoccurrenceï¼‰æ›´é«˜çš„ç»„åˆï¼Œå…¶æ¬¡æ•°å­—çƒ­åº¦ï¼‰
            const hotSums = sumAnalysis.slice(0,5).map(s=>s.sum);
            const sumCandidates = combos.filter(c => hotSums.includes(c.sum) && !c.isHotspot && !isRecentNumber(c.number, analysisPeriods)).sort((a,b)=> (b.occurrence - a.occurrence) || (b.freqSum - a.freqSum));
            addRec('sumTop', sumCandidates.length ? sumCandidates : digitCandidates);

            // 3. å¥‡å¶æ¯”ï¼ˆä¼˜å…ˆç¬¦åˆæœ€é«˜é¢‘å¥‡å¶æ¯”ï¼‰
            const oddEvenCandidates = topOddEven ? combos.filter(c=>c.oddEven === topOddEven && !c.isHotspot && !isRecentNumber(c.number, analysisPeriods)).sort((a,b)=>b.freqSum-a.freqSum) : [];
            addRec('oddEven', oddEvenCandidates.length ? oddEvenCandidates : digitCandidates);

            // 4. å¤§å°æ¯”ï¼ˆä¼˜å…ˆç¬¦åˆæœ€é«˜é¢‘å¤§å°æ¯”ï¼‰
            const bigSmallCandidates = topBigSmall ? combos.filter(c=>c.bigSmall === topBigSmall && !c.isHotspot && !isRecentNumber(c.number, analysisPeriods)).sort((a,b)=>b.freqSum-a.freqSum) : [];
            addRec('bigSmall', bigSmallCandidates.length ? bigSmallCandidates : digitCandidates);

            // 5. å¤§ä¼—å·åˆ†æï¼ˆåŸºäºå‡ºç°é¢‘ç‡ï¼‰ -> ä¸ºé¿å…æ‹¥æŒ¤ï¼Œæ¨èä¸å¤§ä¼—å·æ•°å­—é‡åˆè¾ƒå°‘çš„ç»„åˆ
            const popularDigits = new Set();
            popularCombos.forEach(p=> parseNumber(p.number).forEach(d=> popularDigits.add(d)));
            const popCandidates = combos.filter(c=> !c.isHotspot && !isRecentNumber(c.number, analysisPeriods)).map(c=>{
                const overlap = c.digits.filter(d=> popularDigits.has(d)).length;
                return Object.assign({}, c, { overlap });
            }).sort((a,b)=> a.overlap - b.overlap || b.freqSum - a.freqSum);
            addRec('popularAvoid', popCandidates.length ? popCandidates : digitCandidates);

            // ===== éªŒè¯å¹¶å°½é‡ä¿®æ­£å„é¡¹æ¨èï¼ˆåŸºäºæ¯é¡¹æ¨èè¿›è¡Œå¿«é€Ÿæ ¡éªŒï¼‰ =====
            const recommendationChecks = [];
            function getComboByNumber(num) { return combos.find(c=>c.number === num) || null; }

            // é¢‘ç‡é˜ˆå€¼ï¼ˆå– top 20% ä½œä¸ºæ•°å­—çƒ­åº¦åŸºå‡†ï¼‰
            const topFreqIndex = Math.max(0, Math.floor(combos.length * 0.2) - 1);
            const sortedByFreq = combos.slice().sort((a,b)=>b.freqSum - a.freqSum);
            const freqThreshold = (sortedByFreq[topFreqIndex] && sortedByFreq[topFreqIndex].freqSum) ? sortedByFreq[topFreqIndex].freqSum : 0;

            // å¤§ä¼—å·é‡åˆé˜ˆå€¼ï¼ˆå–é‡åˆæœ€å°çš„ 20%ï¼‰
            const popularDigitsSet = new Set();
            popularCombos.forEach(p=> parseNumber(p.number).forEach(d=> popularDigitsSet.add(d)));
            const popPool = combos.map(c=> Object.assign({}, c, { overlap: c.digits.filter(d=> popularDigitsSet.has(d)).length }));
            const sortedByOverlap = popPool.slice().sort((a,b)=>a.overlap - b.overlap);
            const overlapThresholdIndex = Math.max(0, Math.floor(sortedByOverlap.length * 0.2) - 1);
            const overlapThreshold = (sortedByOverlap[overlapThresholdIndex] && sortedByOverlap[overlapThresholdIndex].overlap) ? sortedByOverlap[overlapThresholdIndex].overlap : 1;

            function validateAndFixSection(section, pool, validator) {
                const orig = recommendations[section] || [];
                const poolCopy = pool.slice();
                const out = [];
                for (let i=0;i<3;i++) {
                    const candidate = orig[i] ? getComboByNumber(orig[i].number) : null;
                    if (candidate && validator(candidate)) {
                        out.push({ number: candidate.number, score: orig[i].score, sum: candidate.sum, ok:true });
                        const idx = poolCopy.findIndex(p=>p.number===candidate.number);
                        if (idx !== -1) poolCopy.splice(idx,1);
                        continue;
                    }
                    const foundIndex = poolCopy.findIndex(c=> validator(c));
                    if (foundIndex !== -1) {
                        const f = poolCopy.splice(foundIndex,1)[0];
                        out.push({ number: f.number, score: 1, sum: f.sum, ok:true, replaced:true });
                    } else {
                        out.push({ number: orig[i] ? orig[i].number : '-', score: orig[i] ? orig[i].score : 0, sum: orig[i] ? orig[i].sum : null, ok:false });
                    }
                }
                recommendations[section] = out.map(o=> ({ number: o.number, score: o.score, sum: o.sum }) );
                const issues = out.filter(o=>!o.ok).map(o=> o.number + ' ä¸ç¬¦åˆ ' + section + ' è¦æ±‚');
                recommendationChecks.push({ section, ok: issues.length===0, issues, samples: out.map(o=>o.number) });
            }

            const validators = {
                digitHeat: c => c.freqSum >= freqThreshold,
                sumTop: c => hotSums.includes(c.sum),
                oddEven: c => (topOddEven ? c.oddEven === topOddEven : true),
                bigSmall: c => (topBigSmall ? c.bigSmall === topBigSmall : true),
                popularAvoid: c => c.overlap <= overlapThreshold
            };

            // å„èŠ‚æ˜¾ç¤ºçš„ä¸­æ–‡åç§°æ˜ å°„
            const SECTION_LABELS = {
                digitHeat: 'æ•°å­—çƒ­åº¦',
                sumTop: 'å’Œå€¼åˆ†å¸ƒ',
                oddEven: 'å¥‡å¶æ¯”',
                bigSmall: 'å¤§å°æ¯”',
                popularAvoid: 'å¤§ä¼—å·ç é¿è®©',
                markov: 'é©¬å°”å¯å¤«'
            };

            // æ‰§è¡Œæ ¡éªŒå¹¶å°è¯•ä¿®æ­£ä¸åˆæ ¼æ¨è
            validateAndFixSection('digitHeat', digitCandidates, validators.digitHeat);
            validateAndFixSection('sumTop', (sumCandidates.length ? sumCandidates : digitCandidates), validators.sumTop);
            validateAndFixSection('oddEven', (oddEvenCandidates.length ? oddEvenCandidates : digitCandidates), validators.oddEven);
            validateAndFixSection('bigSmall', (bigSmallCandidates.length ? bigSmallCandidates : digitCandidates), validators.bigSmall);
            validateAndFixSection('popularAvoid', (popCandidates.length ? popCandidates : digitCandidates), validators.popularAvoid);

            // å°†è‡ªæ£€ç»“æœæ˜ å°„ä¸ºä¾¿äºåœ¨å„èŠ‚åæ˜¾ç¤ºçš„å­—å…¸
            const checkMap = recommendationChecks.reduce((m, rc) => { m[rc.section] = rc; return m; }, {});

            // æ ¹æ®ä¿®æ­£åçš„æ¨èé‡æ–°æ±‡æ€»æƒé‡ï¼ˆåŒ…å«å’Œå€¼ï¼‰
            const aggregate = {};
            Object.entries(recommendations).forEach(([section, items])=>{
                items.forEach(it=>{
                    const combo = getComboByNumber(it.number);
                    const tie = (combo && combo.freqSum) ? combo.freqSum : 0;
                    aggregate[it.number] = aggregate[it.number] || { score: 0, breakdown: {}, sum: it.sum || null, tie: tie };
                    aggregate[it.number].score += it.score; // existing section score
                    // å°†é©¬å°”å¯å¤«è´¡çŒ®åŠ å…¥è¯„åˆ†ï¼šå¦‚æœé©¬å°”å¯å¤«é¢„æµ‹ä¸­åŒ…å«è¯¥ç»„åˆï¼Œå¢åŠ é¢å¤–æƒé‡
                    // è®¡ç®—ä¸€æ¬¡æ€§çš„é©¬å°”å¯å¤«è´¡çŒ®ï¼ˆåç»­ä¼šç»Ÿä¸€æŒ‰æƒé‡åˆå¹¶ï¼‰
                    aggregate[it.number].markov = aggregate[it.number].markov || 0;
                    aggregate[it.number].breakdown[section] = it.score;
                    if (!aggregate[it.number].sum && it.sum) aggregate[it.number].sum = it.sum;
                    // æ›´æ–° tie ä¸ºæœ€å¤§å‡ºç°é¢‘æ¬¡ï¼ˆåˆ©äºæ’åºï¼‰
                    if (tie > (aggregate[it.number].tie || 0)) aggregate[it.number].tie = tie;
                });
            });

            // æœ€ç»ˆæ¨èï¼šå…ˆæŒ‰åˆ†æ•°/tie æ’åºï¼Œç„¶åä½¿ç”¨è´ªå¿ƒå¤šæ ·åŒ–é€‰æ‹©ä»¥é¿å…è¿‡æ‹Ÿåˆï¼ˆé¿å…è¾“å‡ºé«˜åº¦é‡åˆçš„ç»„åˆï¼‰
            const sortedCandidates = Object.entries(aggregate).map(([num, obj])=>({ number: num, score: obj.score, breakdown: obj.breakdown, sum: obj.sum, tie: obj.tie }))
                .sort((a,b)=> (b.score - a.score) || (b.tie - a.tie));

            function digitsOf(num) { return new Set(parseNumber(num)); }

            function pickDiverseTopK(sortedList, k = 3) {
                // å°è¯•ä¸åŒçš„é‡åˆé˜ˆå€¼ï¼ˆå…ˆä¸¥æ ¼ï¼Œè‹¥ä¸å¤Ÿå†æ”¾å®½ï¼‰
                for (let maxOverlap = 1; maxOverlap <= 3; maxOverlap++) {
                    const picked = [];
                    for (const cand of sortedList) {
                        if (picked.length === 0) { picked.push(cand); if (picked.length === k) break; continue; }
                        const dset = digitsOf(cand.number);
                        let ok = true;
                        for (const s of picked) {
                            const sset = digitsOf(s.number);
                            const common = Array.from(dset).filter(x => sset.has(x)).length;
                            if (common > maxOverlap) { ok = false; break; }
                        }
                        if (ok) { picked.push(cand); if (picked.length === k) break; }
                    }
                    if (picked.length === k) return picked;
                }
                // å¦‚æœå®åœ¨æ²¡æ³•æ»¡è¶³ï¼Œç›´æ¥å–æ’åºå‰ k é¡¹ä½œä¸ºæœ€åæ‰‹æ®µ
                return sortedList.slice(0, k);
            }

            // åˆé€‰ï¼ˆä¸å«é©¬å°”å¯å¤«ï¼‰
            // finalRecs å°†åœ¨å°è¯•åŠ å…¥é©¬å°”å¯å¤«æƒé‡åé‡æ–°è®¡ç®—
            let finalRecs = pickDiverseTopK(sortedCandidates, 3);

            // å°†é©¬å°”å¯å¤«é¢„æµ‹çº³å…¥æœ€ç»ˆè¯„åˆ†ï¼šåŸºäºæœ€è¿‘åˆ†ææœŸæ•°è®¡ç®—ä¸€æ¬¡æ€§é¢„æµ‹å¹¶å°†æ¦‚ç‡è½¬æ¢ä¸ºé¢å¤–æƒé‡
            try {
                const mk = computeMarkovInference(recentData, 10);
                const mkMap = {};
                mk.predictions.forEach((p, idx) => { mkMap[p.number] = mkMap[p.number] || { p: (typeof p.prob === 'number' ? p.prob : (typeof p.p === 'number' ? p.p : (p.probText || p.p || 0))), rank: idx + 1 }; });
                // å°† markov æ¦‚ç‡è½¬ä¸ºä¸€ä¸ª 0..3 çš„åˆ†å€¼è´¡çŒ®ï¼ˆæ¦‚ç‡é«˜ç»™æ›´é«˜åˆ†ï¼‰
                Object.entries(aggregate).forEach(([num, obj]) => {
                    const m = mkMap[num];
                    if (m) {
                        const probNum = (typeof m.p === 'number') ? m.p : (parseFloat(('' + m.p).replace('%','')) / 100);
                        const contrib = Math.min(3, Math.round(probNum * 6));
                        obj.score += contrib;
                        obj.markov = contrib;
                        obj.breakdown = obj.breakdown || {};
                        obj.breakdown['markov'] = contrib;
                    }
                });

                // åŸºäºæ›´æ–°åçš„ aggregate é‡å»ºæ’åºæ•°ç»„å¹¶é‡æ–°é€‰å– finalRecs
                const updatedSorted = Object.entries(aggregate).map(([num, obj]) => ({ number: num, score: obj.score, breakdown: obj.breakdown || {}, sum: obj.sum, tie: obj.tie || 0, markov: obj.markov || 0 }));
                updatedSorted.sort((a, b) => (b.score - a.score) || (b.tie - a.tie));
                finalRecs = pickDiverseTopK(updatedSorted, 3);

            } catch (e) {
                console.warn('åº”ç”¨é©¬å°”å¯å¤«è¯„åˆ†å¤±è´¥ï¼Œä½¿ç”¨åˆé€‰æ¨è', e);
            }

            // ç”ŸæˆHTMLæŠ¥å‘Šï¼ˆå«æ¯é¡¹æ¨èä¸æƒé‡ï¼‰
            let html = `
                <div class="analysis-content">
                <h3 style="color: var(--text-primary); margin-bottom: 12px; font-size: 1.1rem;">åŸºäºæœ€è¿‘ ${analysisPeriods} æœŸæ•°æ®çš„åˆ†æä¸æ¨è</h3>

                <div style="margin-bottom: 22px;">
                    <h4 style="color: var(--accent-blue); margin-bottom:8px;">1. æ•°å­—çƒ­åº¦ï¼ˆæŒ‰æ•°å­—å‡ºç°æ¬¡æ•°ï¼‰</h4>
                    <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr);">
                        ${digitAnalysis.map(item => `
                            <div class="stat-item">
                                <div class="value" style="font-size:1.5rem;">${item.digit}</div>
                                <div style="font-size:0.85rem;color:var(--text-secondary);margin-top:4px;">å‡ºç° ${item.count} æ¬¡</div>
                                <div style="font-size:0.75rem;color:var(--text-muted);">${item.frequency}</div>
                            </div>
                        `).join('')}
                    </div>
                    <div style="margin-top:10px;">æ¨èå·ç ï¼š <span class="analysis-recommendation">${ (recommendations.digitHeat||[]).map(r=>{ const combo = getComboByNumber(r.number); return `<span class="rec-item">${r.number}${combo?'<small style="margin-left:6px;color:var(--text-secondary);font-weight:400;">(å¥‡å¶ '+combo.oddEven+'ï¼Œå¤§å° '+combo.bigSmall+')</small>':''} <small style="color:var(--text-secondary);"> (æƒé‡ ${r.score})</small></span>` }).join('')}</span> ${(() => { const c = checkMap['digitHeat']; return `<span style="margin-left:12px;padding:6px 10px;border-radius:6px;background:var(--bg-tertiary);font-weight:600;color:${c && c.ok ? 'var(--success)' : 'var(--warning)'};">è‡ªæ£€ï¼š${c && c.ok ? 'é€šè¿‡' : 'æœªé€šè¿‡'}</span>${c && c.issues && c.issues.length ? `<small style="color:var(--text-secondary);margin-left:8px;">é—®é¢˜ï¼š${c.issues.join('ï¼Œ')}</small>` : ''}` })()}</div>
                </div>

                <div style="margin-bottom: 16px;">
                    <h4 style="color: var(--accent-blue); margin-bottom:8px;">2. å’Œå€¼åˆ†å¸ƒï¼ˆTopï¼‰</h4>
                    <div class="sum-analysis-wrap" style="margin-bottom:8px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                        ${sumAnalysis.slice(0,9).map(s=>`<div style="background:var(--bg-secondary);padding:8px;border-radius:6px;">å’Œå€¼ ${s.sum}<br><small style="color:var(--text-secondary);">${s.count} æ¬¡</small></div>`).join('')}
                    </div>
                    <div>æ¨èå·ç ï¼š <span class="analysis-recommendation">${ (recommendations.sumTop||[]).map(r=>`<span class="rec-item">${r.number}${r.sum?'<small style="margin-left:6px;color:var(--text-secondary);font-weight:400;">(å’Œå€¼ '+r.sum+')</small>':''} <small style="color:var(--text-secondary);"> (æƒé‡ ${r.score})</small></span>`).join('')}</span> ${(() => { const c = checkMap['sumTop']; return `<span style="margin-left:12px;padding:6px 10px;border-radius:6px;background:var(--bg-tertiary);font-weight:600;color:${c && c.ok ? 'var(--success)' : 'var(--warning)'};">è‡ªæ£€ï¼š${c && c.ok ? 'é€šè¿‡' : 'æœªé€šè¿‡'}</span>${c && c.issues && c.issues.length ? `<small style="color:var(--text-secondary);margin-left:8px;">é—®é¢˜ï¼š${c.issues.join('ï¼Œ')}</small>` : ''}` })()}</div>
                </div>

                <div style="display:grid;grid-template-columns:1fr 1fr;gap:18px;margin-bottom:18px;">
                    <div>
                        <h4 style="color: var(--accent-blue);margin-bottom:8px;">3. å¥‡å¶æ¯”åˆ†å¸ƒ</h4>
                        <div style="background:var(--bg-secondary);padding:10px;border-radius:6px;">${oddEvenAnalysis.map(o=>`<div style="margin-bottom:6px;">${o.ratio}ï¼š ${o.count} æ¬¡ (${o.frequency})</div>`).join('')}</div>
                        <div style="margin-top:8px;">æ¨èå·ç ï¼š <span class="analysis-recommendation">${ (recommendations.oddEven||[]).map(r=>`<span class="rec-item">${r.number}${r.sum?'<small style="margin-left:6px;color:var(--text-secondary);font-weight:400;">(å’Œå€¼ '+r.sum+')</small>':''} <small style="color:var(--text-secondary);"> (æƒé‡ ${r.score})</small></span>`).join('')}</span> ${(() => { const c = checkMap['oddEven']; return `<span style="margin-left:12px;padding:6px 10px;border-radius:6px;background:var(--bg-tertiary);font-weight:600;color:${c && c.ok ? 'var(--success)' : 'var(--warning)'};">è‡ªæ£€ï¼š${c && c.ok ? 'é€šè¿‡' : 'æœªé€šè¿‡'}</span>${c && c.issues && c.issues.length ? `<small style="color:var(--text-secondary);margin-left:8px;">é—®é¢˜ï¼š${c.issues.join('ï¼Œ')}</small>` : ''}` })()}</div>
                    </div>

                    <div>
                        <h4 style="color: var(--accent-blue);margin-bottom:8px;">4. å¤§å°æ¯”åˆ†å¸ƒ</h4>
                        <div style="background:var(--bg-secondary);padding:10px;border-radius:6px;">${bigSmallAnalysis.map(b=>`<div style="margin-bottom:6px;">${b.ratio}ï¼š ${b.count} æ¬¡ (${b.frequency})</div>`).join('')}</div>
                        <div style="margin-top:8px;">æ¨èå·ç ï¼š <span class="analysis-recommendation">${ (recommendations.bigSmall||[]).map(r=>`<span class="rec-item">${r.number}${r.sum?'<small style="margin-left:6px;color:var(--text-secondary);font-weight:400;">(å’Œå€¼ '+r.sum+')</small>':''} <small style="color:var(--text-secondary);"> (æƒé‡ ${r.score})</small></span>`).join('')}</span> ${(() => { const c = checkMap['bigSmall']; return `<span style="margin-left:12px;padding:6px 10px;border-radius:6px;background:var(--bg-tertiary);font-weight:600;color:${c && c.ok ? 'var(--success)' : 'var(--warning)'};">è‡ªæ£€ï¼š${c && c.ok ? 'é€šè¿‡' : 'æœªé€šè¿‡'}</span>${c && c.issues && c.issues.length ? `<small style="color:var(--text-secondary);margin-left:8px;">é—®é¢˜ï¼š${c.issues.join('ï¼Œ')}</small>` : ''}` })()}</div>
                    </div>
                </div>

                <div style="margin-bottom:18px;">
                    <h4 style="color: var(--accent-blue);margin-bottom:8px;">5. å¤§ä¼—å·ï¼ˆåŸºäºå‡ºç°é¢‘ç‡ï¼‰</h4>
                    <div class="popular-wrap" style="margin-bottom:10px;">
                        <strong>å¸¸è§ç»„åˆï¼š</strong>
                        ${ popularCombos.length ? `<div class="pair-grid" style="margin-top:8px;">${popularCombos.map(p=>`<div class="pair-item" style="background:var(--bg-tertiary);padding:8px;border-radius:6px;font-family:monospace;color:var(--danger);text-align:center;">${p.number}<div style="font-size:0.85rem;color:var(--text-secondary);margin-top:6px;">${p.count} æ¬¡</div></div>`).join('')}</div>` : '<span style="color:var(--text-secondary);">æš‚æ— å¸¸è§ç»„åˆ</span>'}
                    </div>
                    <div class="pairs-wrap" style="margin-bottom:10px;">
                        <strong>å¯¹å­å·ï¼š</strong>
                        ${pairAnalysis.length ? `<div class="pair-grid" style="margin-top:8px;">${pairAnalysis.slice(0,12).map(p=>`<div class="pair-item" style="background:var(--bg-tertiary);padding:8px;border-radius:6px;font-family:monospace;color:var(--danger);text-align:center;">${p.number}<div style="font-size:0.85rem;color:var(--text-secondary);margin-top:6px;">${p.count} æ¬¡</div></div>`).join('')}</div>` : '<span style="color:var(--text-secondary);">æš‚æ— å¸¸è§å¯¹å­</span>'}
                    </div>
                    <div style="color:var(--text-secondary);margin-bottom:8px;">ä¸ºé¿å…è¿‡å¤šäººé€‰æ‹©ï¼Œå»ºè®®ä¼˜å…ˆé€‰æ‹©ä¸å¤§ä¼—å·æ•°å­—é‡åˆè¾ƒå°‘çš„ç»„åˆï¼š</div>
                    <div>æ¨èå·ç ï¼š <span class="analysis-recommendation">${ (recommendations.popularAvoid||[]).map(r=>`<span class="rec-item">${r.number}${r.sum?'<small style="margin-left:6px;color:var(--text-secondary);font-weight:400;">(å’Œå€¼ '+r.sum+')</small>':''} <small style="color:var(--text-secondary);"> (æƒé‡ ${r.score})</small></span>`).join('')}</span> ${(() => { const c = checkMap['popularAvoid']; return `<span style="margin-left:12px;padding:6px 10px;border-radius:6px;background:var(--bg-tertiary);font-weight:600;color:${c && c.ok ? 'var(--success)' : 'var(--warning)'};">è‡ªæ£€ï¼š${c && c.ok ? 'é€šè¿‡' : 'æœªé€šè¿‡'}</span>${c && c.issues && c.issues.length ? `<small style="color:var(--text-secondary);margin-left:8px;">é—®é¢˜ï¼š${c.issues.join('ï¼Œ')}</small>` : ''}` })()}</div>
                </div>

                <div style="margin-bottom:18px;">
                    <h4 style="color: var(--accent-blue);margin-bottom:8px;">6. é©¬å°”å¯å¤«é“¾æ¨ç†ï¼ˆåŸºäºæœ€è¿‘ ${analysisPeriods} æœŸï¼‰</h4>
                    ${(() => {
                        const mk = computeMarkovInference(recentData, 5);
                        const preds = mk.predictions.map(p=>`<span class="rec-item">${p.number}<small style="margin-left:6px;color:var(--text-secondary)">${p.probText || (p.prob*100).toFixed(2)+'%'}</small></span>`).join(' ');
                        const tops = mk.topTransitions && mk.topTransitions.length ? mk.topTransitions.slice(0,6).map(t=>`${t.from}â†’${t.to}(${t.count})`).join('ï¼Œ') : 'æš‚æ— æ˜¾è‘—è½¬ç§»';
                        return `<div style="margin-bottom:6px;color:var(--text-secondary);">åŸºäºäºŒé˜¶é©¬å°”å¯å¤«ï¼ˆæœ€è¿‘ä¸¤æœŸä¸Šä¸‹æ–‡ï¼‰æ„å»ºçš„è½¬ç§»æ¦‚ç‡ï¼Œé¢„æµ‹ä¸‹ä¸€æœŸæœ€å¯èƒ½å‡ºç°çš„ç»„åˆï¼š</div>
                        <div style="display:flex;gap:12px;align-items:flex-start;">
                          <div style="flex:1;">é¢„æµ‹ï¼š ${preds || '<span style="color:var(--text-secondary)">æ— é¢„æµ‹</span>'}<div id="markovPredBars" style="margin-top:8px;"></div></div>
                          <div style="color:var(--text-secondary);font-size:0.9rem;">Top è½¬ç§»æ ·ä¾‹ï¼š ${tops}</div>
                        </div>
                        <div style="display:flex;gap:16px;margin-top:12px;align-items:flex-start;">
                            <div id="markovGraph" style="border-radius:8px;background:var(--bg-secondary);width:100%;max-width:600px;height:320px;position:relative;overflow:hidden;"></div>
                            <canvas id="markovHeatmap" style="display:none;visibility:hidden;border-radius:8px;background:var(--bg-secondary);width:100%;max-width:600px;height:320px"></canvas>
                            <div style="width:260px;"><div style="font-weight:700;margin-bottom:6px;color:var(--text-primary);">æ•°å­—å‡ºç°é¢‘æ¬¡</div><div id="digitBars"></div><div style="margin-top:12px;"><div style="font-weight:700;margin-bottom:6px;color:var(--text-primary);">ä¸Šä¸‹æ–‡äºŒé˜¶é¢„æµ‹</div><div id="markovContextBars"></div></div></div>
                        </div>`;
                    })()}
                </div>

                <div style="padding:12px;background:var(--bg-secondary);border-radius:8px;">
                    <h4 style="margin-top:0;color:var(--accent-blue);">ç»¼åˆæƒé‡æ±‡æ€»ï¼ˆæœ€ç»ˆæ¨èï¼Œå«é©¬å°”å¯å¤«åŠ æƒï¼‰</h4>
                    <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
                        ${finalRecs.map(r=>`<div style="background:var(--bg-tertiary);padding:8px;border-radius:6px;font-family:monospace;color:var(--accent-cyan);width:220px;">${r.number}${r.sum? 'ï¼ˆå’Œå€¼ '+r.sum+'ï¼‰':''}ï¼ˆæ€»æƒ ${r.score}ï¼‰<br><small style="color:var(--text-secondary);display:block;margin-top:6px;">${Object.entries(r.breakdown||{}).map(([k,v])=> (SECTION_LABELS[k] || k) + ':' + v).join('ï¼Œ')}${r.markov? 'ï¼Œé©¬å°”å¯å¤«+'+r.markov : ''}</small></div>`).join('')}
                    </div>
                </div>
            </div>`;

            $('#analysisContent').html(html);
            $('#analysisSection').show();

            // æ¸²æŸ“é©¬å°”å¯å¤«å¯è§†åŒ–ï¼ˆå»¶å DOM æ’å…¥åæ‰§è¡Œï¼‰
            setTimeout(()=>{
                try {
                    const mk = computeMarkovInference(recentData, 5);
                    renderMarkovGraph(mk, '#markovGraph');
                    // fallback heatmap (hidden) ä¿ç•™ä»¥ä¾¿è°ƒè¯•
                    renderMarkovHeatmap(mk, '#markovHeatmap');
                    renderDigitBars(digitAnalysis, '#digitBars');
                    renderMarkovPredictionBars(mk, '#markovPredBars');
                    const prev = (recentData[1] ? sortNumber(recentData[1].number) : null);
                    const latest = (recentData[0] ? sortNumber(recentData[0].number) : null);
                    renderContextPredictionBars(mk, '#markovContextBars', prev, latest);

                    // ä¸º #markovGraph æ·»åŠ å·¥å…·æ ï¼ˆå…¨å±/ç¼©æ”¾ï¼‰
                    (function attachMarkovToolbar() {
                        const wrap = document.querySelector('#markovGraph');
                        if (!wrap) return;
                        if (wrap.querySelector('.markov-toolbar')) return; // å·²å­˜åœ¨
                        const tb = document.createElement('div');
                        tb.className = 'markov-toolbar chart-toolbar';
                        tb.style.position = 'absolute'; tb.style.top = '8px'; tb.style.right = '8px'; tb.style.zIndex = 20; tb.innerHTML = `
                            <button class="chart-btn" data-target="#markovGraph" data-action="fullscreen">ğŸ” å…¨å±</button>
                            <button class="chart-btn" data-target="#markovGraph" data-action="zoom-in">ï¼‹</button>
                            <button class="chart-btn" data-target="#markovGraph" data-action="zoom-out">ï¼</button>
                        `;
                        wrap.style.position = 'relative';
                        wrap.appendChild(tb);
                    })();

                    // æ¸²æŸ“è¿‘30æœŸèµ°åŠ¿å›¾
                    renderTrendChart(30);
                } catch (e) {
                    console.warn('æ¸²æŸ“é©¬å°”å¯å¤«å¯è§†åŒ–å¤±è´¥', e);
                }
            }, 20);

            // å›¾è¡¨å…¨å±/ç¼©æ”¾å‡½æ•°ä¸äº‹ä»¶ç»‘å®š
            (function setupChartControls(){
                function toggleFullscreenFor(targetSel) {
                    try {
                        const el = document.querySelector(targetSel);
                        if (!el) return;
                        // åˆ‡æ¢æ ·å¼ï¼ˆåŒæ—¶è¯·æ±‚æµè§ˆå™¨å…¨å±ä»¥æ”¯æŒåŸç”Ÿä½“éªŒï¼‰
                        if (!document.fullscreenElement) {
                            if (el.requestFullscreen) el.requestFullscreen().catch(()=>{});
                            el.classList.add('chart-fullscreen');
                        } else {
                            if (document.exitFullscreen) document.exitFullscreen().catch(()=>{});
                            // ç§»é™¤æ‰€æœ‰å¯èƒ½çš„ fullscreen ç±»
                            document.querySelectorAll('.chart-fullscreen').forEach(n=>n.classList.remove('chart-fullscreen'));
                        }
                        // å°è¯• resize Chart.js
                        if (targetSel === '#trendChart' && window.__trendChart) { setTimeout(()=>window.__trendChart.resize(), 120); }
                    } catch (e) { console.warn('toggleFullscreen error', e); }
                }

                function changeZoomFor(targetSel, delta) {
                    try {
                        const el = document.querySelector(targetSel);
                        if (!el) return;
                        let z = parseFloat(el.getAttribute('data-zoom') || '1');
                        z = Math.max(0.6, Math.min(3, +(z + delta).toFixed(2)));
                        el.setAttribute('data-zoom', z);
                        el.classList.add('chart-zoomed');
                        el.style.transform = `scale(${z})`;
                        if (targetSel === '#trendChart' && window.__trendChart) { window.__trendChart.resize(); }
                    } catch (e) { console.warn('changeZoomFor error', e); }
                }

                document.addEventListener('click', function(e){
                    const t = e.target.closest('.chart-btn');
                    if (!t) return;
                    const action = t.getAttribute('data-action');
                    const target = t.getAttribute('data-target');
                    if (!action || !target) return;
                    if (action === 'fullscreen') toggleFullscreenFor(target);
                    if (action === 'zoom-in') changeZoomFor(target, 0.2);
                    if (action === 'zoom-out') changeZoomFor(target, -0.2);
                    if (action === 'reset') {
                        const el = document.querySelector(target);
                        if (!el) return; el.style.transform = '' ; el.setAttribute('data-zoom', '1');
                        if (target === '#trendChart' && window.__trendChart) window.__trendChart.resize();
                    }
                });

                // åŒå‡»åˆ‡æ¢å…¨å±ï¼ˆç§»åŠ¨ç«¯åŒå‡»ä¹Ÿé€‚é…ï¼‰
                document.querySelectorAll('#trendChart, #markovGraph').forEach(el=>{
                    el.addEventListener('dblclick', function(){ const sel = el.id ? '#'+el.id : null; if (sel) toggleFullscreenFor(sel); });
                });

                // ç§»é™¤è¾“å…¥é”™è¯¯é«˜äº®çš„äº‹ä»¶
                $('#analysisPeriods').on('change', function(){ $(this).removeClass('input-error'); });
            })();
        }
        /**
         * ç­–ç•¥Aï¼šæ•°å­¦å‡åŒ€åˆ†å¸ƒï¼ˆé¿å¼€çƒ­ç‚¹ä¸è¿‘æœŸå·ç ï¼‰
         * æ ¸å¿ƒé€»è¾‘ï¼š
         * 1. åœ¨å’Œå€¼åŒºé—´ä¸Šå‡åŒ€åˆ†å¸ƒï¼ˆä½ã€ä¸­ã€é«˜ï¼‰
         * 2. åœ¨è·¨åº¦åˆ†å¸ƒä¸Šå‡åŒ€ï¼ˆå°ã€ä¸­ã€å¤§ï¼‰
         * 3. é¿å…ç­‰å·®æ•°åˆ—å’Œæ˜æ˜¾æ¨¡å¼
         * 4. ä¸‰æ³¨ä¹‹é—´ä¿æŒå·®å¼‚åŒ–
         */
        function strategyMathUniform(options) {
            const { strictMode, aggressiveMode, avoidPeriods } = options;
            const results = [];
            const usedSorted = new Set();

            // è·å–éœ€è¦é¿å¼€çš„æ•°å­—ï¼ˆä¸¥æ ¼æ¨¡å¼ï¼‰
            const avoidDigits = strictMode ? getAvoidDigits(avoidPeriods) : new Set();

            // ç›®æ ‡ï¼šç”Ÿæˆä¸‰æ³¨åœ¨å’Œå€¼åŒºé—´ä¸Šåˆ†æ•£çš„å·ç 
            // å’Œå€¼èŒƒå›´ï¼š0+1+2=3 åˆ° 7+8+9=24ï¼Œä¸­é—´å€¼çº¦13-14
            // åˆ†ä¸ºï¼šä½(3-10)ã€ä¸­(11-16)ã€é«˜(17-24)
            const sumRanges = [
                { min: 3, max: 10, label: 'ä½å’Œå€¼' },
                { min: 11, max: 16, label: 'ä¸­å’Œå€¼' },
                { min: 17, max: 24, label: 'é«˜å’Œå€¼' }
            ];

            for (let i = 0; i < 3; i++) {
                const targetRange = sumRanges[i];
                let attempts = 0;
                let found = false;

                while (!found && attempts < 500) {
                    attempts++;
                    const num = generateRandomZuxuan6(avoidDigits, aggressiveMode);
                    if (!num) continue;

                    const sum = calcSum(num);
                    const sorted = sortNumber(num);

                    // æ£€æŸ¥æ¡ä»¶
                    if (sum >= targetRange.min && sum <= targetRange.max &&
                        !usedSorted.has(sorted) &&
                        !isHotspot(num) &&
                        !isArithmeticSequence(num) &&
                        !isRecentNumber(num, avoidPeriods)) {

                        results.push({
                            number: num,
                            analysis: generateAnalysis(num, 'math', targetRange.label)
                        });
                        usedSorted.add(sorted);
                        found = true;
                    }
                }

                // å¦‚æœç‰¹å®šèŒƒå›´æ‰¾ä¸åˆ°ï¼Œæ”¾å®½æ¡ä»¶
                if (!found) {
                    let fallbackAttempts = 0;
                    while (!found && fallbackAttempts < 200) {
                        fallbackAttempts++;
                        const num = generateRandomZuxuan6(aggressiveMode ? new Set() : avoidDigits, aggressiveMode);
                        if (!num) continue;

                        const sorted = sortNumber(num);
                        if (!usedSorted.has(sorted) && !isHotspot(num) && !isRecentNumber(num, avoidPeriods)) {
                            results.push({
                                number: num,
                                analysis: generateAnalysis(num, 'math', 'å‡è¡¡åˆ†å¸ƒ')
                            });
                            usedSorted.add(sorted);
                            found = true;
                        }
                    }
                }
            }

            return results;
        }

        /**
         * ç­–ç•¥Bï¼šè¿½çƒ­é¿å†·ï¼ˆé¡ºåŠ¿è€Œä¸ºï¼‰
         *
         * æ ¸å¿ƒé€»è¾‘ï¼š
         * 1. æ‰¾å‡ºè¿‘æœŸçƒ­ç ï¼ˆå‡ºç°é¢‘ç‡æœ€é«˜çš„2-3ä¸ªæ•°å­—ï¼‰
         * 2. æ‰¾å‡ºè¿‘æœŸçƒ­å’Œå€¼åŒºé—´
         * 3. å°†çƒ­ç ä½œä¸ºæ ¸å¿ƒï¼Œç»„åˆç”Ÿæˆå·ç 
         * 4. ç¡®ä¿å’Œå€¼è½åœ¨çƒ­åŒº
         */
        function strategyHotTrend(options) {
            const { strictMode, aggressiveMode, avoidPeriods, analysisPeriods } = options;
            const results = [];
            const usedSorted = new Set();
            const recentData = state.historyNumbers.slice(0, analysisPeriods);
            
            // è·å–éœ€è¦é¿å¼€çš„æ•°å­—ï¼ˆä¸¥æ ¼æ¨¡å¼ï¼‰
            const avoidDigits = strictMode ? getAvoidDigits(avoidPeriods) : new Set();
            
            // 1. æ‰¾å‡ºçƒ­ç ï¼ˆå‡ºç°é¢‘ç‡æœ€é«˜çš„3ä¸ªæ•°å­—ï¼‰
            const digitFreq = getDigitFrequency(recentData, analysisPeriods);
            const hotDigits = digitFreq
                .map((count, digit) => ({ digit, count }))
                .sort((a, b) => b.count - a.count)
                .slice(0, 3)
                .map(item => item.digit);
            
            // 2. æ‰¾å‡ºçƒ­å’Œå€¼åŒºé—´ï¼ˆå‡ºç°é¢‘ç‡æœ€é«˜çš„5ä¸ªå’Œå€¼ï¼‰
            const sumFreq = {};
            recentData.forEach(item => {
                const sum = calcSum(item.number);
                sumFreq[sum] = (sumFreq[sum] || 0) + 1;
            });
            const hotSums = Object.entries(sumFreq)
                .map(([sum, count]) => ({ sum: parseInt(sum), count }))
                .sort((a, b) => b.count - a.count)
                .slice(0, 5)
                .map(item => item.sum);
            
            // 3. ç”Ÿæˆå·ç ï¼ŒåŒ…å«è‡³å°‘1ä¸ªçƒ­ç ï¼Œå’Œå€¼ä¸ºçƒ­å’Œå€¼
            for (let i = 0; i < 3; i++) {
                let attempts = 0;
                let found = false;
                
                while (!found && attempts < 500) {
                    attempts++;
                    
                    // ç¡®ä¿åŒ…å«è‡³å°‘ä¸€ä¸ªçƒ­ç 
                    let digits;
                    do {
                        digits = [];
                        // å…ˆé€‰ä¸€ä¸ªçƒ­ç 
                        digits.push(hotDigits[Math.floor(Math.random() * hotDigits.length)]);
                        // å†é€‰ä¸¤ä¸ªéšæœºæ•°å­—ï¼ˆå¯ä»¥æ˜¯çƒ­ç ï¼‰
                        while (digits.length < 3) {
                            const d = Math.floor(Math.random() * 10);
                            if (!digits.includes(d) && !avoidDigits.has(d)) {
                                digits.push(d);
                            }
                        }
                    } while (digits.length < 3);
                    
                    // æ‰“ä¹±é¡ºåºç”Ÿæˆå·ç 
                    const shuffled = [...digits].sort(() => Math.random() - 0.5);
                    const num = shuffled.join('');
                    const sorted = sortNumber(num);
                    const sum = calcSum(num);
                    
                    // æ£€æŸ¥æ¡ä»¶ï¼šåŒ…å«çƒ­ç ï¼Œå’Œå€¼ä¸ºçƒ­å’Œå€¼ï¼Œä¸æ˜¯çƒ­ç‚¹ç»„åˆï¼Œä¸æ˜¯è¿‘æœŸå·ç 
                    if (hotSums.includes(sum) &&
                        !usedSorted.has(sorted) &&
                        !isHotspot(num) &&
                        !isRecentNumber(num, avoidPeriods)) {
                        
                        results.push({
                            number: num,
                            analysis: generateAnalysis(num, 'hot', 'è¿½çƒ­é¿å†·')
                        });
                        usedSorted.add(sorted);
                        found = true;
                    }
                }
                
                // å¤‡ç”¨æ–¹æ¡ˆï¼šæ”¾å®½æ¡ä»¶
                if (!found) {
                    let fallbackAttempts = 0;
                    while (!found && fallbackAttempts < 200) {
                        fallbackAttempts++;
                        const num = generateRandomZuxuan6(aggressiveMode ? new Set() : avoidDigits, aggressiveMode);
                        if (!num) continue;
                        
                        const sorted = sortNumber(num);
                        if (!usedSorted.has(sorted) && !isHotspot(num) && !isRecentNumber(num, avoidPeriods)) {
                            results.push({
                                number: num,
                                analysis: generateAnalysis(num, 'hot', 'è¿½çƒ­é¿å†·ï¼ˆæ”¾å®½æ¡ä»¶ï¼‰')
                            });
                            usedSorted.add(sorted);
                            found = true;
                        }
                    }
                }
            }
            
            return results;
        }

        /**
         * ç­–ç•¥Cï¼šèµŒå†·å›å½’ï¼ˆé€†åŠ¿åšå¼ˆï¼‰
         *
         * æ ¸å¿ƒé€»è¾‘ï¼š
         * 1. æ‰¾å‡ºé•¿æœŸé—æ¼çš„å†·ç 
         * 2. æ‰¾å‡ºè¿‘æœŸå‡ºç°æœ€å°‘çš„å’Œå€¼
         * 3. å¤§èƒ†é€‰ç”¨1-2ä¸ªé¡¶çº§å†·ç ï¼Œæ­é…ä¸­æ€§ç ç»„åˆ
         */
        function strategyColdReturn(options) {
            const { strictMode, aggressiveMode, avoidPeriods, analysisPeriods } = options;
            const results = [];
            const usedSorted = new Set();
            const recentData = state.historyNumbers.slice(0, analysisPeriods);
            
            // è·å–éœ€è¦é¿å¼€çš„æ•°å­—ï¼ˆä¸¥æ ¼æ¨¡å¼ï¼‰
            const avoidDigits = strictMode ? getAvoidDigits(avoidPeriods) : new Set();
            
            // 1. æ‰¾å‡ºå†·ç ï¼ˆå‡ºç°é¢‘ç‡æœ€ä½çš„3ä¸ªæ•°å­—ï¼‰
            const digitFreq = getDigitFrequency(recentData, analysisPeriods);
            const coldDigits = digitFreq
                .map((count, digit) => ({ digit, count }))
                .sort((a, b) => a.count - b.count)
                .slice(0, 3)
                .map(item => item.digit);
            
            // 2. æ‰¾å‡ºå†·å’Œå€¼ï¼ˆå‡ºç°é¢‘ç‡æœ€ä½çš„5ä¸ªå’Œå€¼ï¼‰
            const sumFreq = {};
            recentData.forEach(item => {
                const sum = calcSum(item.number);
                sumFreq[sum] = (sumFreq[sum] || 0) + 1;
            });
            const coldSums = Object.entries(sumFreq)
                .map(([sum, count]) => ({ sum: parseInt(sum), count }))
                .sort((a, b) => a.count - b.count)
                .slice(0, 5)
                .map(item => item.sum);
            
            // 3. ç”Ÿæˆå·ç ï¼ŒåŒ…å«è‡³å°‘1ä¸ªå†·ç ï¼Œå’Œå€¼ä¸ºå†·å’Œå€¼
            for (let i = 0; i < 3; i++) {
                let attempts = 0;
                let found = false;
                
                while (!found && attempts < 500) {
                    attempts++;
                    
                    // ç¡®ä¿åŒ…å«è‡³å°‘ä¸€ä¸ªå†·ç 
                    let digits;
                    do {
                        digits = [];
                        // å…ˆé€‰ä¸€ä¸ªå†·ç 
                        digits.push(coldDigits[Math.floor(Math.random() * coldDigits.length)]);
                        // å†é€‰ä¸¤ä¸ªéšæœºæ•°å­—ï¼ˆå¯ä»¥æ˜¯å†·ç ï¼‰
                        while (digits.length < 3) {
                            const d = Math.floor(Math.random() * 10);
                            if (!digits.includes(d) && !avoidDigits.has(d)) {
                                digits.push(d);
                            }
                        }
                    } while (digits.length < 3);
                    
                    // æ‰“ä¹±é¡ºåºç”Ÿæˆå·ç 
                    const shuffled = [...digits].sort(() => Math.random() - 0.5);
                    const num = shuffled.join('');
                    const sorted = sortNumber(num);
                    const sum = calcSum(num);
                    
                    // æ£€æŸ¥æ¡ä»¶ï¼šåŒ…å«å†·ç ï¼Œå’Œå€¼ä¸ºå†·å’Œå€¼ï¼Œä¸æ˜¯çƒ­ç‚¹ç»„åˆï¼Œä¸æ˜¯è¿‘æœŸå·ç 
                    if (coldSums.includes(sum) &&
                        !usedSorted.has(sorted) &&
                        !isHotspot(num) &&
                        !isRecentNumber(num, avoidPeriods)) {
                        
                        results.push({
                            number: num,
                            analysis: generateAnalysis(num, 'coldreturn', 'èµŒå†·å›å½’')
                        });
                        usedSorted.add(sorted);
                        found = true;
                    }
                }
                
                // å¤‡ç”¨æ–¹æ¡ˆï¼šæ”¾å®½æ¡ä»¶
                if (!found) {
                    let fallbackAttempts = 0;
                    while (!found && fallbackAttempts < 200) {
                        fallbackAttempts++;
                        const num = generateRandomZuxuan6(aggressiveMode ? new Set() : avoidDigits, aggressiveMode);
                        if (!num) continue;
                        
                        const sorted = sortNumber(num);
                        if (!usedSorted.has(sorted) && !isHotspot(num) && !isRecentNumber(num, avoidPeriods)) {
                            results.push({
                                number: num,
                                analysis: generateAnalysis(num, 'coldreturn', 'èµŒå†·å›å½’ï¼ˆæ”¾å®½æ¡ä»¶ï¼‰')
                            });
                            usedSorted.add(sorted);
                            found = true;
                        }
                    }
                }
            }
            
            return results;
        }

        /**
         * ç­–ç•¥Dï¼šç²¾ç¡®é€†å‘ï¼ˆåˆ©ç”¨å¥–é‡‘æ•°æ®ï¼‰
         *
         * æ ¸å¿ƒé€»è¾‘ï¼š
         * 1. æ‰¾å‡ºå¯¼è‡´ç»„é€‰6å¥–é‡‘æœ€ä½çš„å·ç ï¼ˆå¤§ä¼—å·ï¼‰
         * 2. é¿å¼€è¿™äº›å¤§ä¼—å·
         * 3. é¿å¼€ä¸å¤§ä¼—å·æ•°å­—ç»„åˆé«˜åº¦ç›¸ä¼¼çš„å·ç 
         * 4. ç”Ÿæˆä¸å¤§ä¼—å·ç‰¹å¾ç›¸åçš„å·ç 
         */
        function strategyPrecisionReverse(options) {
            const { strictMode, aggressiveMode, avoidPeriods, analysisPeriods } = options;
            const results = [];
            const usedSorted = new Set();
            const recentData = state.historyNumbers.slice(0, analysisPeriods);
            
            // è·å–éœ€è¦é¿å¼€çš„æ•°å­—ï¼ˆä¸¥æ ¼æ¨¡å¼ï¼‰
            const avoidDigits = strictMode ? getAvoidDigits(avoidPeriods) : new Set();
            
            // 1. æ‰¾å‡ºå¤§ä¼—å·ï¼ˆåŸºäºå‡ºç°é¢‘ç‡ï¼›æ’åˆ—3å¥–é‡‘å›ºå®šï¼Œä¸å†ä»¥å¥–é‡‘åˆ¤æ–­ï¼‰
            const comboFreq = {};
            recentData.filter(item => isZuxuan6(item.number)).forEach(it => {
                const s = sortNumber(it.number);
                comboFreq[s] = (comboFreq[s] || 0) + 1;
            });
            const popularNumbers = Object.entries(comboFreq).sort((a,b)=>b[1]-a[1]).slice(0,10).map(([num])=>num);
            
            // 2. æ‰¾å‡ºå¤§ä¼—å·ä¸­é¢‘ç¹å‡ºç°çš„æ•°å­—ï¼ˆéœ€è¦é¿å¼€çš„æ•°å­—ï¼‰
            const popularDigits = new Set();
            popularNumbers.forEach(num => {
                parseNumber(num).forEach(d => popularDigits.add(d));
            });
            
            // 3. ç”Ÿæˆå·ç ï¼Œé¿å¼€å¤§ä¼—å·åŠå…¶ç›¸ä¼¼å·ç 
            for (let i = 0; i < 3; i++) {
                let attempts = 0;
                let found = false;
                
                while (!found && attempts < 500) {
                    attempts++;
                    
                    // ç”Ÿæˆå·ç ï¼Œå°½é‡é¿å¼€å¤§ä¼—å·æ•°å­—
                    let digits;
                    do {
                        digits = [];
                        while (digits.length < 3) {
                            const d = Math.floor(Math.random() * 10);
                            if (!digits.includes(d) && !avoidDigits.has(d)) {
                                digits.push(d);
                            }
                        }
                    } while (digits.length < 3);
                    
                    const num = digits.join('');
                    const sorted = sortNumber(num);
                    const numDigits = new Set(digits);
                    
                    // æ£€æŸ¥æ˜¯å¦ä¸å¤§ä¼—å·é«˜åº¦ç›¸ä¼¼ï¼ˆåŒ…å«2ä¸ªä»¥ä¸Šç›¸åŒæ•°å­—ï¼‰
                    let isSimilar = false;
                    for (const popularNum of popularNumbers) {
                        const popularNumDigits = new Set(parseNumber(popularNum));
                        const intersection = [...numDigits].filter(d => popularNumDigits.has(d));
                        if (intersection.length >= 2) {
                            isSimilar = true;
                            break;
                        }
                    }
                    
                    // æ£€æŸ¥æ¡ä»¶ï¼šä¸æ˜¯å¤§ä¼—å·ï¼Œä¸ä¸å¤§ä¼—å·é«˜åº¦ç›¸ä¼¼ï¼Œä¸æ˜¯çƒ­ç‚¹ç»„åˆï¼Œä¸æ˜¯è¿‘æœŸå·ç 
                    if (!isSimilar &&
                        !popularNumbers.includes(num) &&
                        !usedSorted.has(sorted) &&
                        !isHotspot(num) &&
                        !isRecentNumber(num, avoidPeriods)) {
                        
                        results.push({
                            number: num,
                            analysis: generateAnalysis(num, 'precision', 'ç²¾ç¡®é€†å‘')
                        });
                        usedSorted.add(sorted);
                        found = true;
                    }
                }
                
                // å¤‡ç”¨æ–¹æ¡ˆï¼šæ”¾å®½æ¡ä»¶
                if (!found) {
                    let fallbackAttempts = 0;
                    while (!found && fallbackAttempts < 200) {
                        fallbackAttempts++;
                        const num = generateRandomZuxuan6(aggressiveMode ? new Set() : avoidDigits, aggressiveMode);
                        if (!num) continue;
                        
                        const sorted = sortNumber(num);
                        if (!usedSorted.has(sorted) && !isHotspot(num) && !isRecentNumber(num, avoidPeriods)) {
                            results.push({
                                number: num,
                                analysis: generateAnalysis(num, 'precision', 'ç²¾ç¡®é€†å‘ï¼ˆæ”¾å®½æ¡ä»¶ï¼‰')
                            });
                            usedSorted.add(sorted);
                            found = true;
                        }
                    }
                }
            }
            
            return results;
        }

        /**
         * ç­–ç•¥Bï¼šæ–‡åŒ–é¿å¼€ç­–ç•¥å¼•æ“
         *
         * æ ¸å¿ƒé€»è¾‘ï¼š
         * 1. ä¸»åŠ¨é¿å¼€å‰åˆ©æ•°å­— 6ã€8ã€9
         * 2. ä¼˜å…ˆä½¿ç”¨"ä¸­æ€§"æ•°å­— 0ã€2ã€3ã€5ã€7
         * 3. å¯åŒ…å«é€‚é‡çš„"4"ï¼ˆæ¿€è¿›æ¨¡å¼ï¼‰
         * 4. ç”Ÿæˆè§†è§‰ä¸Š"ä¸ç¾è§‚"çš„ç»„åˆ
         */
        function strategyCultureAvoid(options) {
            const { strictMode, aggressiveMode, avoidPeriods } = options;
            const results = [];
            const usedSorted = new Set();

            // æ–‡åŒ–é¿å¼€æ•°å­—æ± 
            // ä¼˜å…ˆæ•°å­—ï¼š0, 1, 2, 3, 5, 7ï¼ˆä¸åŒ…å«6ã€8ã€9ï¼‰
            // æ¿€è¿›æ¨¡å¼é¢å¤–åŒ…å«ï¼š4
            let preferredDigits = [0, 1, 2, 3, 5, 7];
            if (aggressiveMode) {
                preferredDigits.push(4);
            }

            // è·å–éœ€è¦é¿å¼€çš„æ•°å­—ï¼ˆä¸¥æ ¼æ¨¡å¼ï¼‰
            const avoidDigits = strictMode ? getAvoidDigits(avoidPeriods) : new Set();

            // ä»ä¼˜å…ˆæ•°å­—ä¸­ç§»é™¤éœ€è¦é¿å¼€çš„
            const availableDigits = preferredDigits.filter(d => !avoidDigits.has(d));

            for (let i = 0; i < 3; i++) {
                let attempts = 0;
                let found = false;

                while (!found && attempts < 500) {
                    attempts++;

                    // ä»å¯ç”¨æ•°å­—ä¸­éšæœºé€‰3ä¸ªä¸åŒçš„
                    if (availableDigits.length < 3) {
                        // å¯ç”¨æ•°å­—ä¸è¶³ï¼Œæ”¾å®½é™åˆ¶
                        break;
                    }

                    const shuffled = [...availableDigits].sort(() => Math.random() - 0.5);
                    const selected = shuffled.slice(0, 3);
                    const num = selected.join('');
                    const sorted = sortNumber(num);

                    if (!usedSorted.has(sorted) &&
                        !isHotspot(num) &&
                        !isRecentNumber(num, avoidPeriods)) {

                        results.push({
                            number: num,
                            analysis: generateAnalysis(num, 'culture')
                        });
                        usedSorted.add(sorted);
                        found = true;
                    }
                }

                // å¤‡ç”¨æ–¹æ¡ˆï¼šæ”¾å®½æ¡ä»¶
                if (!found) {
                    let fallbackAttempts = 0;
                    const fallbackDigits = aggressiveMode ? [0,1,2,3,4,5,7] : [0,1,2,3,5,7];

                    while (!found && fallbackAttempts < 200) {
                        fallbackAttempts++;
                        const shuffled = [...fallbackDigits].sort(() => Math.random() - 0.5);
                        const selected = shuffled.slice(0, 3);
                        const num = selected.join('');
                        const sorted = sortNumber(num);

                        if (!usedSorted.has(sorted) && !isHotspot(num)) {
                            results.push({
                                number: num,
                                analysis: generateAnalysis(num, 'culture')
                            });
                            usedSorted.add(sorted);
                            found = true;
                        }
                    }
                }
            }

            return results;
        }

        /**
         * ç­–ç•¥Cï¼šè¿‘æœŸçƒ­å·å†·åƒ»ç­–ç•¥å¼•æ“
         *
         * æ ¸å¿ƒé€»è¾‘ï¼š
         * 1. åˆ†æè¿‘æœŸå¼€å¥–å·ç ä¸­å„æ•°å­—å‡ºç°é¢‘ç‡
         * 2. ä¼˜å…ˆé€‰æ‹©å‡ºç°é¢‘ç‡æœ€ä½çš„"å†·å·"
         * 3. æœ€å¤§ç¨‹åº¦é¿å¼€çƒ­é—¨æ•°å­—
         */
        function strategyColdNumbers(options) {
            const { strictMode, aggressiveMode, avoidPeriods } = options;
            const results = [];
            const usedSorted = new Set();

            // è®¡ç®—æ•°å­—é¢‘ç‡
            const freq = getDigitFrequency(state.historyNumbers, avoidPeriods);

            // æŒ‰é¢‘ç‡æ’åºï¼ˆå‡åºï¼‰ï¼Œè·å–å†·å·
            const sortedDigits = Array.from({length: 10}, (_, i) => i)
                .sort((a, b) => freq[a] - freq[b]);

            // è·å–æœ€å†·çš„æ•°å­—ï¼ˆé¢‘ç‡æœ€ä½çš„å‰6ä¸ªï¼‰
            let coldDigits = sortedDigits.slice(0, 7);

            // ä¸¥æ ¼æ¨¡å¼ï¼šè¿›ä¸€æ­¥è¿‡æ»¤
            if (strictMode) {
                const avoidDigits = getAvoidDigits(avoidPeriods);
                coldDigits = coldDigits.filter(d => !avoidDigits.has(d));
            }

            // éæ¿€è¿›æ¨¡å¼ï¼šç§»é™¤4
            if (!aggressiveMode) {
                coldDigits = coldDigits.filter(d => d !== 4);
            }

            for (let i = 0; i < 3; i++) {
                let attempts = 0;
                let found = false;

                while (!found && attempts < 500) {
                    attempts++;

                    // ä¼˜å…ˆä»å†·å·ä¸­é€‰æ‹©
                    let pool = coldDigits.length >= 3 ? coldDigits : sortedDigits.slice(0, 7);
                    if (!aggressiveMode) {
                        pool = pool.filter(d => d !== 4);
                    }

                    if (pool.length < 3) {
                        pool = [0,1,2,3,5,6,7,8,9];
                    }

                    const shuffled = [...pool].sort(() => Math.random() - 0.5);
                    const selected = shuffled.slice(0, 3);

                    // ç¡®ä¿ä¸‰ä¸ªæ•°å­—ä¸åŒ
                    if (new Set(selected).size !== 3) continue;

                    const num = selected.join('');
                    const sorted = sortNumber(num);

                    if (!usedSorted.has(sorted) &&
                        !isHotspot(num) &&
                        !isRecentNumber(num, avoidPeriods)) {

                        results.push({
                            number: num,
                            analysis: generateAnalysis(num, 'cold', freq)
                        });
                        usedSorted.add(sorted);
                        found = true;
                    }
                }

                // å¤‡ç”¨æ–¹æ¡ˆ
                if (!found) {
                    let fallbackAttempts = 0;
                    while (!found && fallbackAttempts < 200) {
                        fallbackAttempts++;
                        const num = generateRandomZuxuan6(new Set(), aggressiveMode);
                        if (!num) continue;

                        const sorted = sortNumber(num);
                        if (!usedSorted.has(sorted) && !isHotspot(num)) {
                            results.push({
                                number: num,
                                analysis: generateAnalysis(num, 'cold', freq)
                            });
                            usedSorted.add(sorted);
                            found = true;
                        }
                    }
                }
            }

            return results;
        }

        /**
         * ç”Ÿæˆéšæœºç»„é€‰6å·ç 
         */
        function generateRandomZuxuan6(avoidDigits = new Set(), allowFour = false) {
            let pool = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9].filter(d => !avoidDigits.has(d));
            if (!allowFour) {
                pool = pool.filter(d => d !== 4);
            }

            if (pool.length < 3) return null;

            const shuffled = pool.sort(() => Math.random() - 0.5);
            const selected = shuffled.slice(0, 3);
            return selected.join('');
        }

        /**
         * è·å–éœ€è¦é¿å¼€çš„æ•°å­—ï¼ˆä¸¥æ ¼æ¨¡å¼ï¼‰
         */
        function getAvoidDigits(periods) {
            const digits = new Set();
            state.historyNumbers.slice(0, periods).forEach(item => {
                parseNumber(item.number).forEach(d => digits.add(d));
            });
            return digits;
        }

        /**
         * ç”Ÿæˆæ‰€æœ‰å¯èƒ½çš„ç»„é€‰6ï¼ˆ3ä¸ªä¸åŒæ•°å­—ï¼Œä¸é‡å¤ï¼ŒæŒ‰å‡åºè¡¨ç¤ºï¼Œå…± C(10,3)=120 ç§ï¼‰
         */
        function getAllZuxuan6Combos() {
            const combos = [];
            for (let a = 0; a <= 7; a++) {
                for (let b = a + 1; b <= 8; b++) {
                    for (let c = b + 1; c <= 9; c++) {
                        const digits = [a, b, c];
                        const num = digits.join('');
                        combos.push({
                            number: num,
                            digits: digits,
                            sum: digits.reduce((s, d) => s + d, 0),
                            span: Math.max(...digits) - Math.min(...digits),
                            oddEven: `${digits.filter(d => d % 2 === 1).length}:${3 - digits.filter(d => d % 2 === 1).length}`,
                            bigSmall: `${digits.filter(d => d >= 5).length}:${3 - digits.filter(d => d >= 5).length}`,
                            sorted: sortNumber(num)
                        });
                    }
                }
            }
            return combos;
        }

        /**
         * é«˜é˜¶ï¼ˆ2é˜¶ï¼‰é©¬å°”å¯å¤«é“¾æ¨ç†ï¼ˆåŸºäºæœ€è¿‘æœŸæ¬¡çš„ç»„åˆè½¬ç§»ï¼‰
         * - è¾“å…¥ï¼šæŒ‰æ—¶é—´é¡ºåºæœ€è¿‘çš„è‹¥å¹²æœŸ recentDataï¼ˆæœ€æ–°åœ¨ index 0ï¼‰
         * - è¾“å‡ºï¼šé’ˆå¯¹å½“å‰æœ€æ–°ä¸¤æœŸï¼ˆè‹¥å¯ç”¨ï¼‰çš„ topK é¢„æµ‹ï¼ˆå«æ¦‚ç‡åŠåŸå§‹æ¦‚ç‡å€¼ï¼‰ï¼Œå¹¶è¿”å›ç”¨äºå¯è§†åŒ–çš„è½¬ç§»çŸ©é˜µ/è®¡æ•°
         */
        function computeMarkovInference(recentData, topK = 5) {
            // éœ€è¦è‡³å°‘ 2 æ¡ï¼ˆç”¨äº two-step ä¸Šä¸‹æ–‡ï¼‰ï¼›æ„å»ºä¸‰è¿ï¼ˆç”¨äº 2 é˜¶ï¼‰éœ€è¦ >=3
            if (!Array.isArray(recentData) || recentData.length < 2) return { predictions: [], topTransitions: [], trans2: {}, firstOrder: {}, states: [] };

            // æ—¶é—´é¡ºåºï¼šæœ€æ—© -> æœ€æ–°
            const chron = recentData.slice().reverse();

            // trans2: key = 'A|B' -> { C: count }
            const trans2 = {};
            // firstOrder: key = 'A' -> { B: count }
            const firstOrder = {};

            // çŠ¶æ€è®¡æ•°ï¼ˆç”¨äºé€‰çƒ­é—¨çŠ¶æ€ä½œä¸ºçŸ©é˜µè¡Œåˆ—ï¼‰
            const stateCounts = {};

            // æ„å»ºäºŒé˜¶ï¼ˆA,B -> Cï¼‰è½¬ç§»è®¡æ•°ï¼ˆéœ€è¦è‡³å°‘ 3 æ¡è¿ç»­è®°å½•ï¼‰
            for (let i = 0; i < chron.length - 2; i++) {
                const a = sortNumber(chron[i].number);
                const b = sortNumber(chron[i + 1].number);
                const c = sortNumber(chron[i + 2].number);
                const key = `${a}|${b}`;
                trans2[key] = trans2[key] || {};
                trans2[key][c] = (trans2[key][c] || 0) + 1;

                firstOrder[b] = firstOrder[b] || {};
                firstOrder[b][c] = (firstOrder[b][c] || 0) + 1;

                stateCounts[a] = (stateCounts[a] || 0) + 1;
                stateCounts[b] = (stateCounts[b] || 0) + 1;
                stateCounts[c] = (stateCounts[c] || 0) + 1;
            }

            // è¡¥å……ä¸€é˜¶è½¬ç§»ï¼ˆè‹¥æ•°æ®å°‘äº3æ¡æˆ–ä½œä¸ºå›é€€ï¼‰
            for (let i = 0; i < chron.length - 1; i++) {
                const a = sortNumber(chron[i].number);
                const b = sortNumber(chron[i + 1].number);
                firstOrder[a] = firstOrder[a] || {};
                firstOrder[a][b] = (firstOrder[a][b] || 0) + 1;
                stateCounts[a] = (stateCounts[a] || 0) + 1;
                stateCounts[b] = (stateCounts[b] || 0) + 1;
            }

            // è®¡ç®—äºŒé˜¶/ä¸€é˜¶æ¦‚ç‡è¡¨
            const trans2Prob = {};
            Object.keys(trans2).forEach(key => {
                const pairs = trans2[key];
                const total = Object.values(pairs).reduce((s, v) => s + v, 0);
                trans2Prob[key] = Object.entries(pairs).map(([to, c]) => ({ to, count: c, prob: c / total })).sort((x, y) => y.prob - x.prob);
            });

            const firstProb = {};
            Object.keys(firstOrder).forEach(from => {
                const pairs = firstOrder[from];
                const total = Object.values(pairs).reduce((s, v) => s + v, 0);
                firstProb[from] = Object.entries(pairs).map(([to, c]) => ({ to, count: c, prob: c / total })).sort((x, y) => y.prob - x.prob);
            });

            // å…¨å±€è½¬ç§»æ ·æœ¬ï¼ˆæŒ‰æ¬¡æ•°æ’åºï¼‰ä¾›å±•ç¤º
            const global = [];
            Object.keys(trans2).forEach(from => {
                Object.entries(trans2[from]).forEach(([to, c]) => global.push({ from, to, count: c }));
            });
            Object.keys(firstOrder).forEach(from => {
                Object.entries(firstOrder[from]).forEach(([to, c]) => global.push({ from, to, count: c }));
            });
            global.sort((a, b) => b.count - a.count);

            // é¢„æµ‹é€»è¾‘ï¼šä¼˜å…ˆä½¿ç”¨ 2 é˜¶ï¼ˆåŸºäºæœ€è¿‘ä¸¤æœŸï¼‰ï¼Œè‹¥æ— è®°å½•åˆ™å›é€€åˆ° 1 é˜¶ï¼Œå†å›é€€åˆ°å…¨å±€æœ€å¸¸è§
            const latest = sortNumber(recentData[0].number);
            const prev = recentData[1] ? sortNumber(recentData[1].number) : null;
            let predictions = [];

            if (prev && latest) {
                const key = `${prev}|${latest}`;
                if (trans2Prob[key] && trans2Prob[key].length) {
                    predictions = trans2Prob[key].slice(0, topK).map(p => ({ number: p.to, prob: p.prob, probText: (p.prob * 100).toFixed(2) + '%' }));
                }
            }

            if (predictions.length === 0 && latest && firstProb[latest] && firstProb[latest].length) {
                predictions = firstProb[latest].slice(0, topK).map(p => ({ number: p.to, prob: p.prob, probText: (p.prob * 100).toFixed(2) + '%' }));
            }

            if (predictions.length === 0) {
                const seen = new Set();
                const totalGlobal = global.reduce((s, g) => s + g.count, 0) || 1;
                const top = [];
                for (const g of global) {
                    if (!seen.has(g.to)) {
                        seen.add(g.to);
                        top.push({ number: g.to, prob: g.count / totalGlobal, probText: ((g.count / totalGlobal) * 100).toFixed(2) + '%' });
                    }
                    if (top.length >= topK) break;
                }
                predictions = top;
            }

            const topTransitions = global.slice(0, Math.max(10, topK)).map(g => ({ from: g.from, to: g.to, count: g.count }));
            const states = Object.keys(stateCounts).sort((a, b) => stateCounts[b] - stateCounts[a]);

            return { predictions, topTransitions, trans2, firstOrder, trans2Prob, firstProb, states };
        }

        /**
         * å°†é©¬å°”å¯å¤«è½¬ç§»å¯è§†åŒ–ä¸ºçƒ­åŠ›çŸ©é˜µï¼ˆåŸºäºä¸€é˜¶è½¬ç§»çŸ©é˜µï¼Œé’ˆå¯¹çƒ­é—¨çŠ¶æ€æˆªå–å­é›†ï¼‰
         * mk: computeMarkovInference çš„è¿”å›å€¼
         * selector: canvas å…ƒç´ é€‰æ‹©å™¨
         * topStates: å¯é€‰çš„æœ‰åºçŠ¶æ€æ•°ç»„ï¼ˆä¼˜å…ˆä½¿ç”¨ï¼‰ï¼Œå¦åˆ™ä» mk.states ä¸­å–å‰ N
         */
        function renderMarkovHeatmap(mk, selector, topStates) {
            try {
                const canvas = document.querySelector(selector);
                if (!canvas || !mk) return;
                const firstOrder = mk.firstOrder || {};
                const states = (topStates && topStates.length ? topStates.slice(0, 12) : (mk.states || []).slice(0, 12));
                if (!states || states.length === 0) return;

                const N = states.length;
                const pad = 60; // for labels
                const cell = Math.max(18, Math.floor((Math.min(380, window.innerWidth - 200) - pad) / N));
                canvas.width = pad + cell * N;
                canvas.height = pad + cell * N;
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // æ‰¾æœ€å¤§è®¡æ•°
                let maxCount = 0;
                for (let i = 0; i < N; i++) {
                    const from = states[i];
                    for (let j = 0; j < N; j++) {
                        const to = states[j];
                        const cnt = (firstOrder[from] && firstOrder[from][to]) ? firstOrder[from][to] : 0;
                        if (cnt > maxCount) maxCount = cnt;
                    }
                }
                if (maxCount === 0) maxCount = 1;

                // ç»˜åˆ¶æ ¼å­
                for (let i = 0; i < N; i++) {
                    const from = states[i];
                    for (let j = 0; j < N; j++) {
                        const to = states[j];
                        const cnt = (firstOrder[from] && firstOrder[from][to]) ? firstOrder[from][to] : 0;
                        const intensity = cnt / maxCount; // 0..1
                        const colorIntensity = Math.round(240 - intensity * 200); // 40..240
                        ctx.fillStyle = `rgb(${255 - Math.round(intensity * 220)},${colorIntensity},${200 - Math.round(intensity * 160)})`;
                        ctx.fillRect(pad + j * cell, pad + i * cell, cell - 2, cell - 2);

                        // ä¸­é—´å†™æ•°å­—
                        if (cnt > 0) {
                            ctx.fillStyle = intensity > 0.5 ? '#fff' : '#111';
                            ctx.font = Math.max(10, Math.round(cell / 3)) + 'px sans-serif';
                            ctx.textAlign = 'center';
                            ctx.textBaseline = 'middle';
                            ctx.fillText(cnt, pad + j * cell + (cell - 2) / 2, pad + i * cell + (cell - 2) / 2);
                        }
                    }
                }

                // ç»˜åˆ¶è¡Œåˆ—æ ‡ç­¾ï¼ˆæ—‹è½¬åˆ—æ ‡ç­¾ï¼‰
                ctx.fillStyle = 'var(--text-secondary)';
                ctx.font = '11px sans-serif';
                ctx.textAlign = 'right';
                ctx.textBaseline = 'middle';
                for (let i = 0; i < N; i++) {
                    ctx.fillText(states[i], pad - 6, pad + i * cell + (cell - 2) / 2);
                }
                // åˆ—æ ‡ç­¾
                for (let j = 0; j < N; j++) {
                    ctx.save();
                    ctx.translate(pad + j * cell + (cell - 2) / 2, pad - 12);
                    ctx.rotate(-Math.PI / 4);
                    ctx.textAlign = 'left';
                    ctx.fillText(states[j], 0, 0);
                    ctx.restore();
                }

                // caption
                ctx.fillStyle = 'var(--text-secondary)';
                ctx.font = '12px sans-serif';
                ctx.textAlign = 'left';
                ctx.fillText('çƒ­åŠ›å›¾ï¼šæ¥æºï¼ˆè¡Œï¼‰â†’ å»å‘ï¼ˆåˆ—ï¼‰ï¼Œæ•°å­—ä¸ºå‡ºç°æ¬¡æ•°', 6, canvas.height - 8);
            } catch (e) {
                console.warn('æ¸²æŸ“é©¬å°”å¯å¤«çƒ­åŠ›å›¾å¤±è´¥', e);
            }
        }

        // ç®€å•æ•°å­—æ¡å½¢å›¾ï¼ˆåˆ—å‡ºæ•°å­— 0-9 å‡ºç°é¢‘æ¬¡ï¼‰
        function renderDigitBars(digitAnalysis, selector) {
            try {
                const wrap = document.querySelector(selector);
                if (!wrap || !Array.isArray(digitAnalysis)) return;
                const max = Math.max(...digitAnalysis.map(d=>d.count), 1);
                const html = digitAnalysis.map(d=>`<div style="display:flex;align-items:center;margin-bottom:6px;"><div style="width:28px;text-align:right;color:var(--text-primary);margin-right:8px;font-family:monospace;">${d.digit}</div><div style="flex:1;background:var(--bg-secondary);height:14px;border-radius:6px;overflow:hidden;"><div style="height:100%;background:linear-gradient(90deg,var(--accent-cyan),var(--accent-blue));width:${Math.round((d.count/max)*100)}%"></div></div><div style="width:56px;text-align:right;color:var(--text-secondary);margin-left:8px;font-size:0.85rem;">${d.count}</div></div>`).join('');
                wrap.innerHTML = html;
            } catch (e) {
                console.warn('æ¸²æŸ“æ•°å­—æ¡å½¢å›¾å¤±è´¥', e);
            }
        }

        // æ¸²æŸ“é©¬å°”å¯å¤«é¢„æµ‹æ¡å½¢ï¼ˆæ˜¾ç¤ºé¢„æµ‹ç»„åˆæ¦‚ç‡ï¼‰
        function renderMarkovPredictionBars(mk, selector) {
            try {
                const wrap = document.querySelector(selector);
                if (!wrap || !mk) return;
                const preds = mk.predictions || [];
                if (!preds.length) { wrap.innerHTML = '<div style="color:var(--text-secondary);">æš‚æ— é¢„æµ‹</div>'; return; }
                const maxProb = Math.max(...preds.map(p => (typeof p.prob === 'number' ? p.prob : (parseFloat((''+(p.prob||p.probText||0)).replace('%',''))/100))));
                const html = preds.map(p => {
                    const prob = (typeof p.prob === 'number') ? p.prob : (parseFloat((''+(p.prob||p.probText||0)).replace('%',''))/100);
                    const pct = Math.round(prob * 100);
                    return `<div style="margin-bottom:8px;"><div style="display:flex;justify-content:space-between;font-size:0.95rem;color:var(--text-primary);"><div style="font-family:monospace;">${p.number}</div><div style="color:var(--text-secondary);">${(p.probText|| (pct+'%'))}</div></div><div style="background:var(--bg-secondary);height:10px;border-radius:6px;overflow:hidden;margin-top:6px;"><div style="height:100%;background:linear-gradient(90deg,var(--accent-blue),var(--accent-cyan));width:${Math.round((prob/maxProb)*100)}%"></div></div></div>`;
                }).join('');
                wrap.innerHTML = html;
            } catch (e) {
                console.warn('æ¸²æŸ“é©¬å°”å¯å¤«é¢„æµ‹æ¡å½¢å¤±è´¥', e);
            }
        }

        // æ¸²æŸ“ä¸Šä¸‹æ–‡ï¼ˆæœ€è¿‘ä¸¤æœŸï¼‰ä¸‹çš„äºŒé˜¶è½¬ç§»æ¦‚ç‡æ¡å½¢
        function renderContextPredictionBars(mk, selector, prev, latest) {
            try {
                const wrap = document.querySelector(selector);
                if (!wrap || !mk) return;
                if (!prev || !latest) { wrap.innerHTML = '<div style="color:var(--text-secondary);">ä¸Šä¸‹æ–‡ä¸è¶³</div>'; return; }
                const key = `${prev}|${latest}`;
                const list = (mk.trans2Prob && mk.trans2Prob[key]) ? mk.trans2Prob[key] : [];
                if (!list.length) { wrap.innerHTML = '<div style="color:var(--text-secondary);">è¯¥ä¸Šä¸‹æ–‡æ— äºŒé˜¶è½¬ç§»è®°å½•</div>'; return; }
                const maxProb = Math.max(...list.map(l=>l.prob));
                const html = list.slice(0,8).map(l=>{
                    const pct = Math.round(l.prob * 100);
                    return `<div style="margin-bottom:8px;"><div style="display:flex;justify-content:space-between;font-size:0.95rem;color:var(--text-primary);"><div style="font-family:monospace;">${l.to}</div><div style="color:var(--text-secondary);">${pct}%</div></div><div style="background:var(--bg-secondary);height:10px;border-radius:6px;overflow:hidden;margin-top:6px;"><div style="height:100%;background:linear-gradient(90deg,var(--accent-cyan),var(--accent-blue));width:${Math.round((l.prob/maxProb)*100)}%"></div></div></div>`;
                }).join('');
                wrap.innerHTML = html;
            } catch (e) {
                console.warn('æ¸²æŸ“ä¸Šä¸‹æ–‡è½¬ç§»æ¡å½¢å¤±è´¥', e);
            }
        }

        // æ¸²æŸ“é©¬å°”å¯å¤«é“¾å›¾ï¼ˆè½»é‡ SVGï¼ŒèŠ‚ç‚¹æŒ‰ç¯å½¢å¸ƒå±€ï¼Œè¾¹å®½éšè®¡æ•°ï¼‰
        function renderMarkovGraph(mk, selector, topN = 10) {
            try {
                const wrap = document.querySelector(selector);
                if (!wrap || !mk) return;
                const firstOrder = mk.firstOrder || {};
                const states = (mk.states || []).slice(0, Math.max(6, topN));
                if (!states.length) return;
                const W = wrap.clientWidth || 560;
                const H = wrap.clientHeight || 320;
                const cx = W / 2, cy = H / 2, r = Math.min(W, H) / 2 - 40;
                const nodePos = {};
                let maxCnt = 0;
                states.forEach((s, i) => {
                    const angle = (i / states.length) * Math.PI * 2 - Math.PI / 2;
                    const x = cx + Math.cos(angle) * r;
                    const y = cy + Math.sin(angle) * r;
                    nodePos[s] = { x, y };
                    const row = firstOrder[s] || {};
                    Object.values(row).forEach(c => { if (c > maxCnt) maxCnt = c; });
                });
                if (maxCnt === 0) maxCnt = 1;

                const ns = `http://www.w3.org/2000/svg`;
                const svg = document.createElementNS(ns, 'svg');
                svg.setAttribute('width', '100%');
                svg.setAttribute('height', '100%');
                svg.setAttribute('viewBox', `0 0 ${W} ${H}`);
                svg.style.display = 'block';
                svg.innerHTML = '';

                // defs: arrow marker
                const defs = document.createElementNS(ns, 'defs');
                const marker = document.createElementNS(ns, 'marker');
                marker.setAttribute('id', 'arrow');
                marker.setAttribute('markerWidth', '6');
                marker.setAttribute('markerHeight', '6');
                marker.setAttribute('refX', '6');
                marker.setAttribute('refY', '3');
                marker.setAttribute('orient', 'auto');
                const path = document.createElementNS(ns, 'path');
                path.setAttribute('d', 'M0,0 L6,3 L0,6 z');
                path.setAttribute('fill', 'rgba(255,255,255,0.9)');
                marker.appendChild(path);
                defs.appendChild(marker);
                svg.appendChild(defs);

                // edges (curved)
                states.forEach(from => {
                    const row = firstOrder[from] || {};
                    Object.entries(row).forEach(([to, cnt]) => {
                        if (!nodePos[to] || cnt <= 0) return;
                        const p1 = nodePos[from];
                        const p2 = nodePos[to];
                        const mx = (p1.x + p2.x) / 2;
                        const my = (p1.y + p2.y) / 2;
                        const dx = p2.x - p1.x;
                        const dy = p2.y - p1.y;
                        const nd = Math.sqrt(dx*dx+dy*dy);
                        const offset = Math.min(40, nd * 0.25);
                        const ux = -dy / nd;
                        const uy = dx / nd;
                        const cx1 = mx + ux * offset;
                        const cy1 = my + uy * offset;
                        const edge = document.createElementNS(ns, 'path');
                        const strokeW = Math.max(1, Math.round((cnt / maxCnt) * 8));
                        edge.setAttribute('d', `M ${p1.x} ${p1.y} Q ${cx1} ${cy1} ${p2.x} ${p2.y}`);
                        edge.setAttribute('stroke', 'rgba(255,255,255,0.18)');
                        edge.setAttribute('stroke-width', strokeW);
                        edge.setAttribute('fill', 'none');
                        edge.setAttribute('marker-end', 'url(#arrow)');
                        edge.setAttribute('data-from', from);
                        edge.setAttribute('data-to', to);
                        edge.setAttribute('data-cnt', cnt);
                        edge.style.transition = 'opacity 0.12s ease';
                        edge.addEventListener('mouseenter', (e)=>{
                            showMarkovTooltip(`${from} â†’ ${to} : ${cnt} æ¬¡` , e.clientX, e.clientY);
                            edge.setAttribute('stroke', 'rgba(255,255,255,0.38)');
                        });
                        edge.addEventListener('mouseleave', ()=>{ hideMarkovTooltip(); edge.setAttribute('stroke', 'rgba(255,255,255,0.18)'); });
                        svg.appendChild(edge);
                    });
                });

                // nodes
                states.forEach(s => {
                    const p = nodePos[s];
                    const nodeG = document.createElementNS(ns, 'g');
                    nodeG.setAttribute('transform', `translate(${p.x},${p.y})`);
                    const circle = document.createElementNS(ns, 'circle');
                    circle.setAttribute('r', 18);
                    circle.setAttribute('fill', 'var(--bg-tertiary)');
                    circle.setAttribute('stroke', 'rgba(255,255,255,0.06)');
                    circle.setAttribute('stroke-width', '1');
                    circle.style.cursor = 'pointer';
                    nodeG.appendChild(circle);
                    const txt = document.createElementNS(ns, 'text');
                    txt.setAttribute('x', '0');
                    txt.setAttribute('y', '5');
                    txt.setAttribute('text-anchor', 'middle');
                    txt.setAttribute('font-size', '14');
                    txt.setAttribute('fill', 'var(--text-primary)');
                    txt.textContent = s;
                    nodeG.appendChild(txt);
                    nodeG.addEventListener('mouseenter', (e)=>{
                        const row = firstOrder[s] || {};
                        const items = Object.entries(row).sort((a,b)=>b[1]-a[1]).slice(0,6).map(([to,c])=>`${to}: ${c}`).join('\n');
                        showMarkovTooltip(`${s} â†’\n${items}` , e.clientX, e.clientY);
                    });
                    nodeG.addEventListener('mouseleave', ()=>{ hideMarkovTooltip(); });
                    svg.appendChild(nodeG);
                });

                wrap.innerHTML = '';
                wrap.appendChild(svg);

                // ensure tooltip container
                if (!document.getElementById('markovTooltip')) {
                    const t = document.createElement('div'); t.id = 'markovTooltip';
                    t.style.position = 'fixed'; t.style.pointerEvents = 'none'; t.style.padding = '6px 8px'; t.style.fontSize = '12px'; t.style.background = 'rgba(10,12,20,0.95)'; t.style.color = '#fff'; t.style.borderRadius = '6px'; t.style.boxShadow = '0 6px 18px rgba(0,0,0,0.6)'; t.style.display = 'none'; t.style.zIndex = 9999; document.body.appendChild(t);
                }

                function showMarkovTooltip(text, x, y) {
                    const t = document.getElementById('markovTooltip');
                    if (!t) return;
                    t.innerText = text;
                    t.style.left = (x + 12) + 'px';
                    t.style.top = (y + 12) + 'px';
                    t.style.display = 'block';
                }
                function hideMarkovTooltip() {
                    const t = document.getElementById('markovTooltip'); if (t) t.style.display = 'none';
                }

            } catch (e) {
                console.warn('æ¸²æŸ“é©¬å°”å¯å¤«å›¾å¤±è´¥', e);
            }
        }

        // æ¸²æŸ“è¿‘ 30 æœŸèµ°åŠ¿å¹¶è¿›è¡Œç®€å•åˆ†æï¼ˆä½¿ç”¨ Chart.js æ‡’åŠ è½½ï¼‰
        function renderTrendChart(lastN = 30) {
            try {
                const data = (state.historyNumbers || []).slice(0, lastN).slice().reverse(); // oldest -> newest
                if (!data.length) { document.getElementById('trendAnalysis').innerText = 'æš‚æ— æ•°æ®'; return; }
                const labels = data.map(d=>d.period || '').map((p,i)=> (i+1));
                const pos1 = data.map(d=>parseInt((d.number||'000')[0]||0));
                const pos2 = data.map(d=>parseInt((d.number||'000')[1]||0));
                const pos3 = data.map(d=>parseInt((d.number||'000')[2]||0));
                const sums = data.map(d=>pos1[data.indexOf(d)] + pos2[data.indexOf(d)] + pos3[data.indexOf(d)]);

                const plot = ()=>{
                    const ctx = document.getElementById('trendChart').getContext('2d');
                    if (window.__trendChart) { window.__trendChart.destroy(); window.__trendChart = null; }
                    window.__trendChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [
                                {label: 'ä½1', data: pos1, borderColor: 'rgba(59,130,246,0.9)', backgroundColor: 'rgba(59,130,246,0.08)', tension:0.3, pointRadius:2},
                                {label: 'ä½2', data: pos2, borderColor: 'rgba(139,92,246,0.9)', backgroundColor: 'rgba(139,92,246,0.08)', tension:0.3, pointRadius:2},
                                {label: 'ä½3', data: pos3, borderColor: 'rgba(6,182,212,0.9)', backgroundColor: 'rgba(6,182,212,0.08)', tension:0.3, pointRadius:2},
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {mode: 'index', intersect: false},
                            scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                        }
                    });
                };

                if (window.Chart) { plot(); } else {
                    // æ‡’åŠ è½½ Chart.jsï¼ˆCDNï¼‰
                    const src = 'https://cdn.jsdelivr.net/npm/chart.js';
                    if (!document.querySelector(`script[src="${src}"]`)) {
                        const s = document.createElement('script'); s.src = src; s.async = true; s.onload = ()=>{ setTimeout(plot, 30); }; document.head.appendChild(s);
                    } else {
                        setTimeout(plot, 30);
                    }
                }

                // ç®€å•èµ°åŠ¿åˆ†æ
                const freq = {};
                data.forEach(d=>{ (d.number||'').split('').forEach(ch=>{ freq[ch] = (freq[ch]||0)+1; }); });
                const top = Object.entries(freq).sort((a,b)=>b[1]-a[1]).slice(0,5).map(t=>`${t[0]}(${t[1]})`).join('ï¼Œ');
                const odd = data.reduce((s,d)=> s + ((parseInt((d.number||'000')[0])%2?1:0) + (parseInt((d.number||'000')[1])%2?1:0) + (parseInt((d.number||'000')[2])%2?1:0)), 0);
                const totalDigits = data.length * 3;
                const oddPct = Math.round((odd/totalDigits)*100);
                // å¯¹å’Œå€¼æ–œç‡åšçº¿æ€§æ‹Ÿåˆ
                const xs = sums.map((v,i)=>i);
                const ys = sums;
                const n = xs.length;
                const avgX = xs.reduce((a,b)=>a+b,0)/n; const avgY = ys.reduce((a,b)=>a+b,0)/n;
                let num=0, den=0; for (let i=0;i<n;i++){ num += (xs[i]-avgX)*(ys[i]-avgY); den += (xs[i]-avgX)*(xs[i]-avgX); }
                const slope = den===0 ? 0 : num/den;
                const trend = slope > 0.1 ? 'ä¸Šå‡è¶‹åŠ¿' : (slope < -0.1 ? 'ä¸‹é™è¶‹åŠ¿' : 'æ— æ˜æ˜¾è¶‹åŠ¿');
                document.getElementById('trendAnalysis').innerHTML = `<div>æœ€è¿‘ ${data.length} æœŸå¸¸è§å·ç ï¼š${top}</div><div>å¥‡æ•°å æ¯”ï¼š${oddPct}%ï¼ˆè¿‘${data.length}æœŸå…±${odd}ä¸ªå¥‡æ•°ï¼‰</div><div>å’Œå€¼èµ°åŠ¿ï¼š${trend}</div>`;

            } catch (e) { console.warn('æ¸²æŸ“èµ°åŠ¿å›¾å¤±è´¥', e); document.getElementById('trendAnalysis').innerText = 'èµ°åŠ¿å›¾æ¸²æŸ“å¤±è´¥'; }
        }

        // åœ¨æ¸²æŸ“å®Œæˆåï¼Œè‹¥éœ€è¦å¯è°ƒç”¨ renderTrendChart(30)

        /**
         * æ£€æŸ¥æ˜¯å¦ä¸è¿‘æœŸå·ç é‡å¤
         */
        function isRecentNumber(num, periods) {
            const sorted = sortNumber(num);
            let p = parseInt(periods);
            if (!Number.isInteger(p) || p <= 0) {
                // è‹¥æœªä¼ å…¥æœ‰æ•ˆæœŸæ•°ï¼Œé»˜è®¤æ£€æŸ¥æœ€è¿‘ up to 500 æ¡æˆ–å½“å‰å¯ç”¨çš„æœ€å¤§æœŸæ•°
                p = Math.min(500, state.historyNumbers.length);
            }
            p = Math.min(p, state.historyNumbers.length);
            return state.historyNumbers.slice(0, p).some(item =>
                sortNumber(item.number) === sorted
            );
        }

        /**
         * ç”Ÿæˆç­–ç•¥åˆ†ææ–‡æœ¬
         */
        function generateAnalysis(num, strategy, extra = null) {
            const sum = calcSum(num);
            const span = calcSpan(num);
            const oddEven = calcOddEven(num);
            const bigSmall = calcBigSmall(num);
            const digits = parseNumber(num);

            let baseAnalysis = `å’Œå€¼<span class="highlight">${sum}</span>ï¼Œè·¨åº¦<span class="highlight">${span}</span>ï¼Œå¥‡å¶æ¯”${oddEven}ï¼Œå¤§å°æ¯”${bigSmall}ã€‚`;

            switch (strategy) {
                case 'math':
                    baseAnalysis += ` æ­¤ç»„åˆå±äº<span class="highlight">${extra || 'å‡è¡¡åˆ†å¸ƒ'}</span>åŒºé—´ï¼Œéç­‰å·®æ•°åˆ—ï¼Œæ•°å­—åˆ†å¸ƒå‡åŒ€ã€‚`;
                    break;
                case 'culture':
                    const hasLucky = digits.some(d => [6, 8, 9].includes(d));
                    if (!hasLucky) {
                        baseAnalysis += ` å®Œå…¨é¿å¼€å‰åˆ©æ•°å­—6ã€8ã€9ï¼Œä½¿ç”¨<span class="highlight">ä¸­æ€§æ•°å­—</span>ç»„åˆã€‚`;
                    } else {
                        baseAnalysis += ` ä»¥ä¸­æ€§æ•°å­—ä¸ºä¸»ï¼Œè§†è§‰ä¸Š<span class="highlight">"ä¸è®¨å–œ"</span>ï¼Œé¿å¼€å¤§ä¼—åå¥½ã€‚`;
                    }
                    break;
                case 'cold':
                    if (extra) {
                        const coldInfo = digits.map(d => `${d}(é¢‘${extra[d]}æ¬¡)`).join('ã€');
                        baseAnalysis += ` ä½¿ç”¨å†·å·ï¼š${coldInfo}ï¼Œ<span class="highlight">è¿‘æœŸä½é¢‘</span>ç»„åˆã€‚`;
                    }
                    break;
            }

            return baseAnalysis;
        }

        /**
         * ä¸»ç”Ÿæˆå‡½æ•°
         */
        function generateNumbers(strategy) {
            // è¯»å–å¹¶è§„èŒƒè¾“å…¥å€¼ï¼Œé¿å… NaN å¯¼è‡´é¿å¼€æœ€è¿‘æœŸæ•°åŠŸèƒ½å¤±æ•ˆ
            const rawAnalysis = parseInt($('#analysisPeriods').val());
            const desiredAnalysis = Number.isInteger(rawAnalysis) && rawAnalysis > 0 ? Math.min(rawAnalysis, 500) : 100;
            // å¦‚æœå½“å‰å¯ç”¨æ•°æ®ä¸è¶³ï¼Œåˆ™æç¤ºå¹¶å°è¯•åŠ è½½æ›´å¤šï¼›è¿”å›ç©ºç»“æœï¼Œç­‰å¾…æ•°æ®åŠ è½½å®Œæˆåç”¨æˆ·å¯é‡è¯•
            if (state.historyNumbers.length < desiredAnalysis) {
                // æä¾›æ›´æ˜ç¡®çš„é”™è¯¯ä¿¡æ¯ä¾› UI ä½¿ç”¨ï¼ˆä¸å†ç›´æ¥è¿”å›ç©ºæ•°ç»„ï¼‰ï¼Œå¹¶å°è¯•åå°åŠ è½½æ›´å¤š
                const msg = 'å¯ç”¨å¼€å¥–æ•°æ®ä¸è¶³ï¼ˆå½“å‰ ' + state.historyNumbers.length + ' æœŸï¼‰ï¼Œè¯·å‡å°‘åˆ†ææœŸæ•°æˆ–ä¿å­˜å†å²åé‡è¯•ã€‚';
                showError(msg);
                if (!state.isLoading) {
                    const neededPages = Math.max(1, Math.ceil(desiredAnalysis / 100));
                    fetchHistoryData(neededPages, 100);
                }
                return { error: 'insufficient_data', available: state.historyNumbers.length, desired: desiredAnalysis, message: msg };
            }
            const analysisPeriods = Math.min(desiredAnalysis, state.historyNumbers.length, 500);
            const rawAvoid = parseInt($('#avoidPeriods').val());
            // è‹¥ avoidPeriods æœªè®¾ç½®æˆ–éæ³•ï¼Œé»˜è®¤ä¸ analysisPeriods ä¿æŒä¸€è‡´
            const avoidPeriods = Number.isInteger(rawAvoid) && rawAvoid > 0 ? Math.min(rawAvoid, state.historyNumbers.length) : analysisPeriods; 

            const options = {
                strictMode: $('#strictMode').is(':checked'),
                aggressiveMode: $('#aggressiveMode').is(':checked'),
                avoidPeriods: avoidPeriods,
                analysisPeriods: analysisPeriods
            };

            switch (strategy) {
                case 'math':
                    return strategyMathUniform(options);
                case 'culture':
                    return strategyCultureAvoid(options);
                case 'cold':
                    return strategyColdNumbers(options);
                case 'hot':
                    return strategyHotTrend(options);
                case 'coldreturn':
                    return strategyColdReturn(options);
                case 'precision':
                    return strategyPrecisionReverse(options);
                default:
                    return strategyMathUniform(options);
            }
        }

        // ========== UI æ¸²æŸ“å‡½æ•° ==========

        /**
         * æ¸²æŸ“å†å²è®°å½•åˆ—è¡¨
         */
        function renderHistoryList() {
            const $list = $('#historyList');

            if (state.historyNumbers.length === 0) {
                $list.html('<div class="loading-state"><p>æš‚æ— æ•°æ®</p></div>');
                return;
            }

            let html = '';
            state.historyNumbers.forEach((item, index) => {
                html += `
                    <div class="history-item" data-index="${index}">
                        <div>
                            <span class="num">${item.number}</span>
                            <span class="date">${item.date} ç¬¬${item.period}æœŸ</span>
                        </div>
                        <button class="delete-btn" data-index="${index}">Ã—</button>
                    </div>
                `;
            });

            $list.html(html);
        }

        /**
         * æ¸²æŸ“çƒ­ç‚¹å·ç 
         */
        function renderHotspots() {
            const displayHotspots = [
                '123', '456', '789', '147', '258', '369',
                '666', '888', '168', '268', '518', '618',
                '520', '521', '741', '852', '963', '159'
            ];

            let html = '';
            displayHotspots.forEach(num => {
                html += `<span class="hotspot-tag">${num}</span>`;
            });

            $('#hotspotGrid').html(html);
        }

        /**
         * æ¸²æŸ“ç»Ÿè®¡ä¿¡æ¯
         */
        function renderStats() {
            const periods = parseInt($('#avoidPeriods').val());
            const freq = getDigitFrequency(state.historyNumbers, periods);

            const digitsSorted = Array.from({length:10}, (_, i) => ({ digit: i, freq: freq[i] }))
                .sort((a,b) => b.freq - a.freq);

            const hotTop = digitsSorted.slice(0, 3);
            const coldTop = digitsSorted.slice(-3).reverse();

            const html = `
                <div class="stat-item">
                    <div class="value">${hotTop.map(d=>d.digit).join(', ')}</div>
                    <div class="label">çƒ­å·ï¼ˆTop 3ï¼‰</div>
                    <div style="font-size:0.75rem;color:var(--text-secondary);margin-top:6px;">${hotTop.map(d=>d.freq + 'æ¬¡').join(' Â· ')}</div>
                </div>
                <div class="stat-item">
                    <div class="value">${coldTop.map(d=>d.digit).join(', ')}</div>
                    <div class="label">å†·å·ï¼ˆTop 3ï¼‰</div>
                    <div style="font-size:0.75rem;color:var(--text-secondary);margin-top:6px;">${coldTop.map(d=>d.freq + 'æ¬¡').join(' Â· ')}</div>
                </div>
            `;

            $('#statsGrid').html(html);
        }

        /* ========== å®Œæ•´å¼€å¥–è®°å½•è¡¨æ ¼åŠŸèƒ½ ========== */
        function setupFullHistoryTable() {
            const pageSize = 50;
            state.fullTable = state.fullTable || {};
            state.fullTable.pageSize = pageSize;
            state.fullTable.currentPage = 0;
            state.fullTable.totalPages = Math.ceil((state.historyNumbers || []).length / pageSize);
            state.fullTable.loading = false;

            const $tbody = $('#fullHistoryTable tbody');
            $tbody.html('');

            if ((state.historyNumbers || []).length === 0) {
                $tbody.html('<tr><td colspan="11" style="text-align:center;color:var(--text-secondary);padding:20px;">æš‚æ— æ•°æ®</td></tr>');
                $('#loadMoreBtn').prop('disabled', true).text('æš‚æ— æ•°æ®');
                return;
            }

            $('#loadMoreBtn').prop('disabled', false).text('åŠ è½½æ›´å¤š');
            // åŠ è½½ç¬¬ä¸€é¡µ
            loadNextTablePage();
        }

        function loadNextTablePage() {
            if (!state.fullTable) setupFullHistoryTable();
            if (state.fullTable.loading) return;
            if (state.fullTable.currentPage >= state.fullTable.totalPages) return;

            state.fullTable.loading = true;
            $('#loadMoreBtn').text('åŠ è½½ä¸­...').prop('disabled', true);

            const start = state.fullTable.currentPage * state.fullTable.pageSize;
            const end = start + state.fullTable.pageSize;
            const rows = (state.historyNumbers || []).slice(start, end);
            const $tbody = $('#fullHistoryTable tbody');

            rows.forEach(item => {
                const num = item.rawResult || (item.number || '').split('').join(' ');
                const zhixuanCount = item.prizeZhixuan ? item.prizeZhixuan.stakeCount : '-';
                const zhixuanAmt = item.prizeZhixuan ? item.prizeZhixuan.stakeAmount : '-';
                const z3Count = item.prizeZuxuan3 ? item.prizeZuxuan3.stakeCount : '-';
                const z3Amt = item.prizeZuxuan3 ? item.prizeZuxuan3.stakeAmount : '-';
                const z6Count = item.prizeZuxuan6 ? item.prizeZuxuan6.stakeCount : '-';
                const z6Amt = item.prizeZuxuan6 ? item.prizeZuxuan6.stakeAmount : '-';
                const sale = item.totalSaleAmount || '-';
                const pdf = item.drawPdfUrl ? `<a href="${item.drawPdfUrl}" target="_blank">å…¬å‘Š</a>` : (item.lotteryNotice ? 'æœ‰' : '-');

                $tbody.append(`
                    <tr>
                        <td style="font-family: monospace;">${item.period}</td>
                        <td>${item.date}</td>
                        <td style="font-family: monospace; color: var(--accent-cyan); font-weight:600;">${num}</td>
                        <td>${zhixuanCount}</td>
                        <td>${zhixuanAmt}</td>
                        <td>${z3Count}</td>
                        <td>${z3Amt}</td>
                        <td>${z6Count}</td>
                        <td>${z6Amt}</td>
                        <td>${sale}</td>
                        <td>${pdf}</td>
                    </tr>
                `);
            });

            state.fullTable.currentPage++;
            state.fullTable.loading = false;

            const loadedAll = state.fullTable.currentPage >= state.fullTable.totalPages;
            $('#loadMoreBtn').text(loadedAll ? 'å·²åŠ è½½å…¨éƒ¨' : 'åŠ è½½æ›´å¤š').prop('disabled', loadedAll);
        }

        // æ»‘åŠ¨åˆ°åº•éƒ¨è‡ªåŠ¨åŠ è½½ä¸‹ä¸€é¡µï¼ˆç§»åŠ¨ç«¯å‹å¥½ï¼‰
        $('#fullTableContainer').on('scroll', function() {
            const $el = $(this);
            if ($el[0].scrollHeight - $el.scrollTop() - $el.outerHeight() < 120) {
                loadNextTablePage();
            }
        });

        // åŠ è½½æ›´å¤šæŒ‰é’®
        $('#loadMoreBtn').on('click', function() {
            loadNextTablePage();
        });

        /* ========== æ‰‹åŠ¨ç²˜è´´ä¸å¯¼å‡ºä¸ºå•æ–‡ä»¶ HTML çš„å·¥å…·å‡½æ•° ========== */
        function normalizeApiItem(item) {
            // æ”¯æŒ API åŸå§‹é¡¹æˆ–å·²æ ‡å‡†åŒ–çš„é¡¹
            const rawResult = item.lotteryDrawResult || item.rawResult || '';
            const compact = (rawResult || (item.number || '')).toString().replace(/\s+/g, '');

            const getPrizeInfo = (prizeList, levelName, groupKey) => {
                if (!prizeList || !Array.isArray(prizeList)) return { stakeCount: '0', stakeAmount: '0' };
                const prize = prizeList.find(p => p.prizeLevel === levelName || p.group === groupKey) || prizeList.find(p => p.group === groupKey) || {};
                return {
                    stakeCount: (prize.stakeCount !== undefined) ? String(prize.stakeCount) : (prize.stakeCount || '0'),
                    stakeAmount: (prize.stakeAmountFormat || prize.stakeAmount || prize.stakeAmount || '0')
                };
            };

            return {
                number: compact,
                rawResult: rawResult || compact.split('').join(' '),
                date: item.lotteryDrawTime || item.date || '',
                period: item.lotteryDrawNum || item.period || '',
                prizeZhixuan: getPrizeInfo(item.prizeLevelList || item.prizeLevelList || [], 'ç›´é€‰', '10'),
                prizeZuxuan3: getPrizeInfo(item.prizeLevelList || item.prizeLevelList || [], 'ç»„é€‰3', '20'),
                prizeZuxuan6: getPrizeInfo(item.prizeLevelList || item.prizeLevelList || [], 'ç»„é€‰6', '30'),
                totalSaleAmount: item.totalSaleAmount || item.totalSaleAmountFormat || item.totalSale || '-',
                drawPdfUrl: item.drawPdfUrl || item.pdf || '',
                lotteryNotice: item.lotteryNotice || 0
            };
        }

        /* å·²ç§»é™¤æ‰‹åŠ¨ç²˜è´´å¯¼å…¥åŠŸèƒ½ï¼Œå¦‚éœ€å¯¼å…¥è¯·ä½¿ç”¨æ–‡ä»¶å¯¼å…¥æˆ–æ‰“å¼€åŒ…å« window.PRELOADED_HISTORY çš„å•æ–‡ä»¶ HTML */

        function generateSelfContainedHTML() {
            // åœ¨å½“å‰é¡µé¢ HTML ä¸­æ³¨å…¥ PRELOADED_HISTORY æ•°æ®å¹¶ä½œä¸ºå•æ–‡ä»¶ä¸‹è½½
            try {
                const html = '<!doctype html>\n' + document.documentElement.outerHTML;
                const dataScript = `<script>window.PRELOADED_HISTORY = ${JSON.stringify(state.historyNumbers)};<\/script>`;
                const injected = html.replace('</body>', dataScript + '\n</body>');
                const blob = new Blob([injected], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const ts = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
                a.download = `anti-crowd-lottery_${ts}.html`;
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url);
                showError('å·²ç”Ÿæˆå•æ–‡ä»¶ HTMLï¼Œä¸‹è½½åº”å·²å¼€å§‹');
            } catch (e) {
                showError('ç”Ÿæˆæ–‡ä»¶å¤±è´¥ï¼š' + e.message);
            }
        }

        /**
         * æ¸²æŸ“ç”Ÿæˆç»“æœ
         */
        function renderResults(results) {
            // å¤„ç†é”™è¯¯å¯¹è±¡
            if (!results || (typeof results === 'object' && results.error)) {
                const err = results || { error: 'unknown' };
                if (err.error === 'insufficient_data') {
                    const msg = err.message || ('å¯ç”¨å¼€å¥–æ•°æ®ä¸è¶³ï¼ˆå½“å‰ ' + (err.available || 0) + ' æœŸï¼‰');
                    showError('ç”Ÿæˆå¤±è´¥ï¼š' + msg);

                    const html = `
                        <div class="card">
                            <h3 class="card-title"><span class="icon">âš ï¸</span> ç”Ÿæˆå¤±è´¥</h3>
                            <div style="padding:12px;color:var(--text-secondary);">${msg} å»ºè®®ï¼š
                                <ul style="margin-top:8px;">
                                    <li>å‡å°‘åˆ†ææœŸæ•°ï¼ˆè°ƒæ•´â€œåˆ†ææœŸæ•°â€ä¸‹æ‹‰ï¼‰</li>
                                    <li>æˆ– ä¿å­˜å½“å‰å†å²ä¸ºå•æ–‡ä»¶ç¦»çº¿åå†é‡æ–°è½½å…¥</li>
                                </ul>
                            </div>
                            <div style="display:flex;gap:10px;margin-top:12px;">
                                <button class="chart-btn" id="autoAdjustBtn">è‡ªåŠ¨è°ƒæ•´å¹¶é‡è¯•ï¼ˆä½¿ç”¨å¯ç”¨ ${err.available || 0} æœŸï¼‰</button>
                                <button class="chart-btn" id="exportForOfflineBtn">ä¿å­˜ä¸ºå•æ–‡ä»¶ï¼ˆç”¨äºç¦»çº¿ï¼‰</button>
                                <button class="chart-btn" id="dismissFailBtn">å…³é—­</button>
                            </div>
                        </div>
                    `;
                    $('#resultsGrid').html(html);
                    $('#resultsSection').addClass('show');

                    // é«˜äº®åˆ†ææœŸæ•°å¹¶æŠ–åŠ¨æç¤º
                    $('#analysisPeriods').addClass('input-error');
                    setTimeout(()=>$('#analysisPeriods').removeClass('input-error'), 900);

                    // ç»‘å®šæŒ‰é’®è¡Œä¸º
                    $('#autoAdjustBtn').on('click', function() {
                        $('#analysisPeriods').val(Math.min(err.available || 0, 500));
                        $('#generateBtn').click();
                    });
                    $('#exportForOfflineBtn').on('click', function() { generateSelfContainedHTML(); });
                    $('#dismissFailBtn').on('click', function() { $('#resultsGrid').html(''); $('#resultsSection').removeClass('show'); });

                    // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
                    $('html, body').animate({ scrollTop: $('#resultsSection').offset().top - 20 }, 500);
                    return;
                }

                // å…¶å®ƒæœªçŸ¥é”™è¯¯
                showError('ç”Ÿæˆå¤±è´¥ï¼Œè¯·è°ƒæ•´å‚æ•°åé‡è¯•');
                return;
            }

            // æ­£å¸¸ç»“æœæ¸²æŸ“
            let html = '';
            results.forEach((item, index) => {
                html += `
                    <article class="result-card">
                        <p class="label">ç¬¬ ${index + 1} æ³¨</p>
                        <p class="number">${item.number}</p>
                        <div class="analysis">${item.analysis}</div>
                    </article>
                `;
            });

            $('#resultsGrid').html(html);
            $('#resultsSection').addClass('show');

            // æ˜¾ç¤ºéšæœºæ´å¯Ÿ
            const randomInsight = CONFIG.INSIGHTS[Math.floor(Math.random() * CONFIG.INSIGHTS.length)];
            $('#insightQuote').text(`"${randomInsight}"`);

            // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
            $('html, body').animate({
                scrollTop: $('#resultsSection').offset().top - 20
            }, 500);
        }

        // ========== äº‹ä»¶ç»‘å®š ==========

        $(document).ready(function() {
            /* å·²ç§»é™¤è¯»å–æœ¬åœ°ä»£ç†çš„é€»è¾‘ï¼ˆå‰ç«¯ä¸å†ç»´æŠ¤ä»£ç†é…ç½®ï¼‰ */

            // åˆå§‹åŒ–ï¼šåŠ è½½æ•°æ®
            async function init() {
                const ok = await fetchHistoryData(5, 100); // è·å–500æœŸæ•°æ®ï¼š5é¡µï¼Œæ¯é¡µ100æ¡
                renderHistoryList();
                renderHotspots();
                renderStats();
                if (ok) {
                    setupFullHistoryTable();
                }
            }

            init();

            // ç­–ç•¥å¡ç‰‡ç‚¹å‡»
            $('.strategy-card').on('click', function() {
                $('.strategy-card').removeClass('active');
                $(this).addClass('active');
                state.selectedStrategy = $(this).data('strategy');
            });

            // ç”ŸæˆæŒ‰é’®ç‚¹å‡»
            $('#generateBtn').on('click', async function() {
                const $btn = $(this);

                if (state.isLoading) return;
                state.isLoading = true;
                $btn.addClass('loading');

                // æ¨¡æ‹ŸçŸ­æš‚å»¶è¿Ÿï¼Œå¢å¼ºä½“éªŒ
                await new Promise(resolve => setTimeout(resolve, 800));

                const results = generateNumbers(state.selectedStrategy);
                renderResults(results);
                
                // ç”Ÿæˆæ•°æ®åˆ†ææŠ¥å‘Š
                generateAnalysisReport();

                state.isLoading = false;
                $btn.removeClass('loading');
            });

            // åˆ·æ–°æ•°æ®
            $('#refreshBtn').on('click', async function() {
                const $btn = $(this);
                $btn.text('åˆ·æ–°ä¸­...');

                const ok = await fetchHistoryData();
                if (!ok) {
                    // fetch å¤±è´¥æ—¶ï¼ŒfetchHistoryData ä¼šæ˜¾ç¤ºæ‰‹åŠ¨å›é€€æç¤ºï¼ˆè‹¥è¢«æ‹¦æˆªï¼‰ï¼Œæ­¤å¤„ä»…ç¡®ä¿ manual UI å¯è§
                    $('#manualFetchFallback').show();
                }

                renderHistoryList();
                renderStats();
                setupFullHistoryTable();

                // å½“æˆåŠŸè·å–åˆ°æ•°æ®åï¼Œæç¤ºç”¨æˆ·å¯ä»¥å°†æ•°æ®ä¿å­˜åˆ°å•æ–‡ä»¶ HTMLï¼ˆç”¨äºç¦»çº¿ä¿ç•™ï¼‰
                $('#exportBtn').prop('disabled', false).text('ä¿å­˜ä¸ºå•æ–‡ä»¶');

                $btn.text('åˆ·æ–°æ•°æ®');
            });

            // æ·»åŠ å·ç 
            $('#addNumberBtn').on('click', function() {
                const input = $('#newNumber').val().trim();

                if (!/^\d{3}$/.test(input)) {
                    showError('è¯·è¾“å…¥3ä½æ•°å­—å·ç ');
                    return;
                }

                // æ·»åŠ åˆ°å†å²è®°å½•å¼€å¤´
                state.historyNumbers.unshift({
                    number: input,
                    rawResult: input.split('').join(' '),
                    date: new Date().toISOString().split('T')[0],
                    period: 'æ‰‹åŠ¨æ·»åŠ ',
                    prizeZhixuan: { stakeCount: '0', stakeAmount: '0' },
                    prizeZuxuan3: { stakeCount: '0', stakeAmount: '0' },
                    prizeZuxuan6: { stakeCount: '0', stakeAmount: '0' },
                    totalSaleAmount: '-'
                });

                $('#newNumber').val('');
                renderHistoryList();
                renderStats();
                setupFullHistoryTable();
            });

            // å›è½¦æ·»åŠ å·ç 
            $('#newNumber').on('keypress', function(e) {
                if (e.which === 13) {
                    $('#addNumberBtn').click();
                }
            });

            /* å·²ç§»é™¤æœªä½¿ç”¨çš„ç²˜è´´æ•°æ®æŒ‰é’®äº‹ä»¶ï¼ˆé¡µé¢ä¸åŒ…å« #applyPastedBtn/#applyAndSaveBtn/#clearPastedBtnï¼‰ã€‚ */

            // å•æ–‡ä»¶å¯¼å‡ºï¼ˆå°†å½“å‰å†å²æ•°æ®æ³¨å…¥é¡µé¢ä¾›ç¦»çº¿ä½¿ç”¨ï¼‰ ğŸ”§
            $('#exportBtn').on('click', function() {
                generateSelfContainedHTML();
            });


            // åˆ é™¤å†å²å·ç 
            $('#historyList').on('click', '.delete-btn', function(e) {
                e.stopPropagation();
                const index = $(this).data('index');
                state.historyNumbers.splice(index, 1);
                renderHistoryList();
                renderStats();
                setupFullHistoryTable();
            });

            // é¿å¼€æœŸæ•°å˜åŒ–
            $('#avoidPeriods').on('change', function() {
                renderStats();
            });
        });
    </script>
</body>
</html>
